import{guess as Q}from"https://cdn.jsdelivr.net/npm/web-audio-beat-detector/+esm";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function i(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(t){if(t.ep)return;t.ep=!0;const s=i(t);fetch(t.href,s)}})();window.guess=Q;EventTarget.prototype._nativeEventListener=EventTarget.prototype._nativeEventListener||EventTarget.prototype.addEventListener;for(let d of[Window,Document,HTMLIFrameElement])d.prototype.addEventListener=new Proxy(d.prototype.addEventListener,{apply:(a,i,e)=>(e[1]&&(e[1]=new Proxy(e[1],{apply:(t,s,o)=>{var u;try{if((u=document.querySelector("#modMenu"))!=null&&u.contains(o[0].target))return!1}catch{}return t.apply(s,o)}})),a.apply(i,e))});const ae="wss://73a59210-8993-4b29-8c5b-b0d9f2edf0f5-00-33hnin010jlp8.janeway.replit.dev",V=new WebSocket(ae);window._mod_WS=V;V.onopen=()=>{console.log("Connected to server")};V.onmessage=d=>{if(console.log(d.data),d.data.startsWith("connect-req:")){const a=d.data.split(":")[1];confirm(`Player ${a} wants to connect to you. Accept?`)?(M(`connect-accept:${a}`),H=!0,window.opponent=a):M(`connect-reject:${a}`)}if(d.data.startsWith("connect-accepted")){const a=d.data.split(":")[1];window.opponent=a,window.basketLoading.then(()=>setInterval(()=>{B===!0&&M(`data-json:${JSON.stringify({type:"event",event:"update",target:opponent,players:window.players.map(i=>({x:i.x,y:i.y,instVars:i.instVars})),heads:window.heads.map(i=>({x:i.x,y:i.y,instVars:i.instVars})),ball:{x:window.ball.x,y:window.ball.y,instVars:{hold:window.ball.instVars.hold,who:window.ball.instVars.who}}})}`)},10))}if(d.data.startsWith("ids-available")){const a=d.data.split(":")[1].split(",").filter(i=>!!i);if(a.find(i=>i===x)&&a.splice(a.indexOf(x),1),a.length>=1){if(JSON.stringify(a)===JSON.stringify([...[...document.querySelectorAll(".player + span")].map(e=>e.textContent)]))return;document.getElementById("connect-button").disabled=!1;const i=document.getElementById("available-players");i.innerHTML="";for(let e of a)if(e!==x){const t=document.createElement("input");t.type="radio",t.name="player",t.className="player",t.value=e,i.appendChild(t),i.innerHTML+=`<span>${e}</span><br />`}}}if(d.data.startsWith("data-json:")){const a=JSON.parse(d.data.split("data-json:")[1]);re(a)}};V.onclose=()=>{console.log("Disconnected from server")};function M(d){V.send(d)}function re(d={}){if(d.target!==x)return!1;if(d.type==="event"){if(d.event==="keydown"){for(let[e,t]of enumerate(d.players)){const s=window.players.find((o,u)=>e===u);if(s){s.x=t.x,s.y=t.y;for(let[o,u]of Object.entries(t.instVars))s.instVars[o]=u}}for(let[e,t]of enumerate(d.heads)){const s=window.heads.find((o,u)=>e===u);if(s){s.x=t.x,s.y=t.y;for(let[o,u]of Object.entries(t.instVars))s.instVars[o]=u}}const a=window.ball;a.x=d.ball.x,a.y=d.ball.y;for(let[e,t]of Object.entries(d.ball.instVars))a.instVars[e]=t;const i=new KeyboardEvent("keydown",{key:d.key,which:d.which,keyCode:d.keyCode,code:d.code});window.dispatchEvent(i)}else if(d.event==="keyup"){const a=new KeyboardEvent("keyup",{key:d.key,which:d.which,keyCode:d.keyCode,code:d.code});window.dispatchEvent(a)}else if(d.event==="update"){if(keys.w||keys.W||keys.ArrowUp)return!1;for(let[i,e]of enumerate(d.players)){const t=window.players.find((s,o)=>i===o);if(t){t.x=e.x,t.y=e.y;for(let[s,o]of Object.entries(e.instVars))t.instVars[s]=o}}for(let[i,e]of enumerate(d.heads)){const t=window.heads.find((s,o)=>i===o);if(t){t.x=e.x,t.y=e.y;for(let[s,o]of Object.entries(e.instVars))t.instVars[s]=o}}const a=window.ball;a.x=d.ball.x,a.y=d.ball.y;for(let[i,e]of Object.entries(d.ball.instVars))a.instVars[i]=e}}}class J{constructor(){this.mediaRecorder=null,this.chunks=[],this.isRecording=!1}async startRecording(){if(this.isRecording){console.warn("Recording is already in progress.");return}try{const a=document.querySelector("canvas").captureStream(45);this.chunks=[],this.mediaRecorder=new MediaRecorder(a,{mimeType:"video/webm; codecs=vp9"}),this.mediaRecorder.ondataavailable=i=>{i.data.size>0&&this.chunks.push(i.data)},this.mediaRecorder.start(1e3),this.isRecording=!0,console.log("Recording started.")}catch(a){console.error("Error starting recording:",a)}}stopRecording(){if(!this.isRecording){console.warn("No recording in progress to stop.");return}this.mediaRecorder.stop(),this.isRecording=!1,console.log("Recording stopped.")}saveRecording(){const a=new Blob(this.chunks,{type:"video/webm"}),i=URL.createObjectURL(a),e=document.createElement("a");e.href=i,e.download="recording.webm",document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(i),console.log("Recording saved.")}}class le{constructor(){this.recorders=[]}startCapturing(){this.recorders=[],this.recorders.push(new J),this.recorders[0].startRecording(),setInterval(()=>{this.addRecorder()},1e4)}addRecorder(){let a=this.recorders.push(new J)-1;this.recorders.at(a).startRecording(),setTimeout(()=>{this.recorders.at(a).stopRecording(),this.recorders.splice(a,1)},3e4)}stopCapturing(){for(let a of this.recorders)a.stopRecording()}saveClip(){this.recorders.at(0).saveRecording()}}const F=new le;window._nativeEventListener("keydown",d=>{if(!d.isTrusted)return!1;B===!0&&(d.key==="w"?M(`data-json:${JSON.stringify({type:"event",event:"keydown",key:"w",which:87,keyCode:87,code:"KeyW",target:opponent,players:window.players.map(a=>({x:a.x,y:a.y,instVars:a.instVars})),heads:window.heads.map(a=>({x:a.x,y:a.y,instVars:a.instVars})),ball:{x:window.ball.x,y:window.ball.y,instVars:window.ball.instVars}})}`):d.key==="ArrowUp"&&M(`data-json:${JSON.stringify({type:"event",event:"keydown",key:"ArrowUp",which:38,keyCode:38,code:"ArrowUp",target:opponent,players:window.players.map(a=>({x:a.x,y:a.y,instVars:a.instVars})),heads:window.heads.map(a=>({x:a.x,y:a.y,instVars:a.instVars})),ball:{x:window.ball.x,y:window.ball.y,instVars:window.ball.instVars}})}`))});window._nativeEventListener("keyup",d=>{if(!d.isTrusted)return!1;B===!0&&(d.key==="w"?M(`data-json:${JSON.stringify({type:"event",event:"keyup",key:"w",which:87,keyCode:87,code:"KeyW",target:opponent})}`):d.key==="ArrowUp"&&M(`data-json:${JSON.stringify({type:"event",event:"keyup",key:"ArrowUp",which:38,keyCode:38,code:"ArrowUp",target:opponent})}`))});Object.defineProperties(window,{ball:{get:()=>c3_runtimeInterface._localRuntime._iRuntime.objects.balls.getAllInstances()[0]},players:{get:()=>[c3_runtimeInterface._localRuntime._iRuntime.objects.body.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.body2.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.body3.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.body4.getAllInstances()[0]]},heads:{get:()=>[c3_runtimeInterface._localRuntime._iRuntime.objects.head.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.head2.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.head3.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.head4.getAllInstances()[0]]},globalVars:{get:()=>c3_runtimeInterface._localRuntime._iRuntime.globalVars}});function Z(){var d=c3_runtimeInterface._localRuntime._iRuntime.objects["body"+(C===1?"":C)].getAllInstances()[0],a=c3_runtimeInterface._localRuntime._iRuntime.objects["head"+(C===1?"":C)].getAllInstances()[0];d.x=X(),d.y=136,d.instVars.angular=0,d.instVars.angle=0,d.instVars.degreeAngle=0,a.x=X(),a.y=136,a.instVars.angular=0,a.instVars.angle=0,a.instVars.degreeAngle=0,z(C)}let B=!1,x=null,H=!1;window.opponent=null;function ce(){B=!0,x===null&&(x=Math.random().toString(36).substring(7),document.getElementById("multi-id").textContent=x),M(`open-connect:${x}`)}function de(){B=!1,document.getElementById("connect-button").disabled=!0;const d=document.getElementById("available-players");d.innerHTML=""}let q=!1,G=!1;async function ee(){await window.basketLoading,ie(),q=!0;for(var[d,a,i,e]of[[...c3_runtimeInterface._localRuntime._iRuntime.objects.body.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.body2.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.body3.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.body4.getAllInstances()],[...c3_runtimeInterface._localRuntime._iRuntime.objects.head.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.head2.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.head3.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.head4.getAllInstances()]])d.instVars._x=d.x,d.instVars._y=d.y,d.instVars._angle=d.angle,d.instVars._angular=d.instVars.angular,i.instVars._x=i.x,i.instVars._y=i.y,i.instVars._angle=i.angle,i.instVars._angular=i.instVars.angular,d.x=1e3,i.x=1e3}let C=4;async function te(){await window.basketLoading,ie(),G=!0;var d=[c3_runtimeInterface._localRuntime._iRuntime.objects.body.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.body2.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.body3.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.body4.getAllInstances()[0]].filter(u=>u!==c3_runtimeInterface._localRuntime._iRuntime.objects["body"+(C===1?"":C)].getAllInstances()[0]),a=[c3_runtimeInterface._localRuntime._iRuntime.objects.head.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.head2.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.head3.getAllInstances()[0],c3_runtimeInterface._localRuntime._iRuntime.objects.head4.getAllInstances()[0]].filter(u=>u!==c3_runtimeInterface._localRuntime._iRuntime.objects["head"+(C===1?"":C)].getAllInstances()[0]);for(var[i,e,t,s]of[d,a])i.instVars._x=i.x,i.instVars._y=i.y,i.instVars._angle=i.angle,i.instVars._angular=i.instVars.angular,e.instVars._x=e.x,e.instVars._y=e.y,e.instVars._angle=e.angle,e.instVars._angular=e.instVars.angular,t.instVars._x=t.x,t.instVars._y=t.y,t.instVars._angle=t.angle,t.instVars._angular=t.instVars.angular,i.x=1e3,e.x=1e3,t.x=1e3;var o=c3_runtimeInterface._localRuntime._iRuntime.objects["body"+(C===1?"":C)].getAllInstances()[0];o.instVars._x=o.x,o.instVars._y=o.y,o.instVars._angle=o.angle,o.instVars._angular=o.instVars.angular,z(C)}var X=()=>{switch(C){case 1:return 125;case 2:return 210;case 3:return 175;case 4:return 100}};_nativeEventListener("keypress",d=>{if(G&&(d.key==="b"&&z(C),d.key==="r")){z(C);var a=c3_runtimeInterface._localRuntime._iRuntime.objects["body"+(C===1?"":C)].getAllInstances()[0],i=c3_runtimeInterface._localRuntime._iRuntime.objects["head"+(C===1?"":C)].getAllInstances()[0];a.x=X(),a.y=136,a.instVars.angular=0,a.instVars.angle=0,a.instVars.degreeAngle=0,i.x=X(),i.y=136,i.instVars.angular=0,i.instVars.angle=0,i.instVars.degreeAngle=0}});function z(d){var a=c3_runtimeInterface._localRuntime._iRuntime.objects.balls.getAllInstances()[0];a.instVars.hold=1,a.instVars.who=d}function ie(){var d=c3_runtimeInterface._localRuntime._iRuntime.objects.balls.getAllInstances()[0];d.instVars.hold=0,d.instVars.who=-1}document.head.insertAdjacentHTML("beforeend",`
<style>
    .mod-menu {
        width: 350px;
        background: #000;
        border: 1px solid #ccc;
        position: fixed;
        top: 50px;
        left: 50px;
        z-index: 1000;
    }

    #gravity-value {
        width: 15px;
        display: inline-block;
        padding-left: 3px;
    }

    .mod-menu.minimized {
        display: none;
    }
    
    .title-bar {
        background: #333;
        color: white;
        padding: 5px;
        cursor: move;
    }
    
    .content {
        padding: 10px;
    }
    
    .minimize-button {
        float: right;
        cursor: pointer;
        color: white;
        background: none;
        border: none;
    }
</style>
`);const L=document.createElement("div");L.id="modMenu";L.className="mod-menu";const ne=document.createElement("div");ne.className="title-bar";const I=document.createElement("div");I.className="content";I.innerHTML=`
    <h1>Random Mods</h1>
    <label for="modSlider">Gravity (4 default)</label>
    <span id="gravity-value">4</span>
    <input type="range" id="gravity-changer" min="0" max="30" value="4">
    <label for="activate-oneone">Activate 1v1 Game</label>
    <button id="activate-oneone">Activate</button>
    <br />
    <label for="activate-practice">Activate Practice</label>
    <button id="activate-practice">Activate</button>
    <form class="practice-form">
        <input type="radio" id="player1-practice" name="practice" value="1">
        <label for="player1-practice">Player 1</label><br>

        <input type="radio" id="player2-practice" name="practice" value="2">
        <label for="player2-practice">Player 2</label><br>

        <input type="radio" id="player3-practice" name="practice" value="3">
        <label for="player3-practice">Player 3</label><br>

        <input type="radio" id="player4-practice" name="practice" value="4" checked>
        <label for="player4-practice">Player 4</label><br>
    </form>
    <hr />
    <h2>Multiplayer</h2>
    <label for="enable-multi">Enable</label>
    <input type="checkbox" id="enable-multi" name="enable multiplayer" value="Enable">
    <br />
    <h3 style="margin-bottom: 5px;">Available Players:</h3>
    <h5 style="margin-top: 0px; margin-bottom: 5px;">Your ID: <span id="multi-id">${x||""}</span></h5>
    <form id="available-players" style="margin-bottom: 5px;"></form>
    <button id="connect-button" disabled="true">Connect</button>
    <hr />
    <h2>Clipping</h2>
    <label for="enable-clip">Enable</label>
    <input type="checkbox" id="enable-clip" name="enable clipping" value="Enable">
    <span id="clip-time">00:00</span>
    <br />
    <button id="capture-30s" disabled="true">Record Last 30 seconds</button>
    <hr />
    <h2>Custom Score</h2>
    <h5 style="margin-top: 0px; margin-bottom: 5px;">Current: <span id="score-value">5</span></h5>
    <label for="score">Score</label>
    <span id="score-current" style="width: 16px; display: inline-block; text-align: center;">5</span>
    <input type="range" id="score" min="0" max="20" value="5">
    <button id="score-submit">Save</button>
`;let $=0;setInterval(()=>{F.mediaRecorder&&F.mediaRecorder.state==="recording"?($+=100,document.getElementById("clip-time").textContent=new Date($).toISOString().substr(14,5)):$=0},100);I.querySelector(".practice-form")._nativeEventListener("change",d=>{const a=document.querySelector(".practice-form"),e=new FormData(a).get("practice");C=parseInt(e)});L.appendChild(ne);L.appendChild(I);document.body.appendChild(L);I.querySelector("#gravity-changer")._nativeEventListener("input",d=>{I.querySelector("#gravity-value").textContent=d.target.value,c3_runtimeInterface._localRuntime._pluginManager._allBehaviors[0].SetGravity(parseInt(d.target.value))});I.querySelector("#enable-multi")._nativeEventListener("input",()=>{I.querySelector("#enable-multi").checked?ce():de()});let T=5,O=[0,0];I.querySelector("#score-submit")._nativeEventListener("click",()=>{const d=I.querySelector("#score").value;I.querySelector("#score-value").textContent=d,T=d});I.querySelector("#score")._nativeEventListener("input",d=>{I.querySelector("#score-current").textContent=d.target.value});I.querySelector("#enable-clip")._nativeEventListener("input",()=>{I.querySelector("#enable-clip").checked?(document.getElementById("capture-30s").disabled=!1,F.startCapturing()):(document.getElementById("capture-30s").disabled=!0,F.stopCapturing())});I.querySelector("#activate-practice")._nativeEventListener("click",()=>{if(G===!0){for(var[d,a,i,e]of[[...c3_runtimeInterface._localRuntime._iRuntime.objects.body.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.body2.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.body3.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.body4.getAllInstances()],[...c3_runtimeInterface._localRuntime._iRuntime.objects.head.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.head2.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.head3.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.head4.getAllInstances()]])d.x=d.instVars._x,d.y=d.instVars._y,d.angle=d.instVars._angle,d.instVars.angular=d.instVars._angular,a.x=a.instVars._x,a.y=a.instVars._y,a.angle=a.instVars._angle,a.instVars.angular=a.instVars._angular,i.x=i.instVars._x,i.y=i.instVars._y,i.angle=i.instVars._angle,i.instVars.angular=i.instVars._angular,e.x=e.instVars._x,e.y=e.instVars._y,e.angle=e.instVars._angle,e.instVars.angular=e.instVars._angular;return G=!1}te()});I.querySelector("#activate-oneone")._nativeEventListener("click",()=>{if(q===!0){for(var[d,a,i,e]of[[...c3_runtimeInterface._localRuntime._iRuntime.objects.body.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.body2.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.body3.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.body4.getAllInstances()],[...c3_runtimeInterface._localRuntime._iRuntime.objects.head.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.head2.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.head3.getAllInstances(),...c3_runtimeInterface._localRuntime._iRuntime.objects.head4.getAllInstances()]])d.x=d.instVars._x,d.y=d.instVars._y,d.angle=d.instVars._angle,d.instVars.angular=d.instVars._angular,i.x=i.instVars._x,i.y=i.instVars._y,i.angle=i.instVars._angle,i.instVars.angular=i.instVars._angular;return q=!1}ee()});document.getElementById("available-players")._nativeEventListener("submit",d=>{new FormData(form).get("player"),d.preventDefault()},!1);document.getElementById("connect-button")._nativeEventListener("click",()=>{if(H===!0)return!1;H=!0;const d=document.getElementById("available-players"),i=new FormData(d).get("player");if(i===null)return H=!1,!1;M(`connect:${i}`)});ue(L);function ue(d){var a=0,i=0,e=0,t=0;document.querySelector(d.id+" .title-bar")?document.querySelector(d.id+" .title-bar").onmousedown=s:d.querySelector(".title-bar").onmousedown=s;function s(h){h=h||window.event,h.preventDefault(),e=h.clientX,t=h.clientY,d.querySelector(".title-bar").onmouseup=u,document.onmousemove=o}function o(h){h=h||window.event,h.preventDefault(),a=e-h.clientX,i=t-h.clientY,e=h.clientX,t=h.clientY,d.style.top=d.offsetTop-i+"px",d.style.left=d.offsetLeft-a+"px"}function u(){d.querySelector(".title-bar").onmouseup=null,document.onmousemove=null}}_nativeEventListener("keydown",d=>{d.key==="m"&&document.getElementById("modMenu").classList.toggle("minimized")});let se;window.basketLoading=new Promise(d=>{se=d});function he(){console.log("starting"),oe()}function oe(){c3_runtimeInterface._localRuntime._pluginManager._allBehaviors[0].SetGravity(parseInt(I.querySelector("#gravity-changer").value)),q===!0&&ee(),G===!0&&te()}_nativeEventListener("basket-ready",()=>{window.AudioDOMHandler.prototype._Play=new Proxy(window.AudioDOMHandler.prototype._Play,{apply:(d,a,i)=>{if(console.log(i[0]),i[0].originalUrl==="file"){if(ball.x>225&&ball.y>75&&ball.y<80&&ball.instVars.hold===0){if(O[0]++,c3_runtimeInterface._localRuntime._layoutManager._layoutsByName.get("game")._layersByName.get("ui")._instances[2]._sdkInst._SetText(String(O[0])),c3_runtimeInterface._localRuntime._layoutManager._layoutsByName.get("game")._layersByName.get("ui")._instances[3]._sdkInst._SetText(String(O[1])),O[0]>=T)return O=[0,0],globalVars.p1Score=T;if(O[1]>=T)return O=[0,0],globalVars.p2Score=T;globalVars.p1Score=0,globalVars.p2Score=0}if(ball.x<80&&ball.y>75&&ball.y<80&&ball.instVars.hold===0){if(O[1]++,c3_runtimeInterface._localRuntime._layoutManager._layoutsByName.get("game")._layersByName.get("ui")._instances[2]._sdkInst._SetText(String(O[0])),c3_runtimeInterface._localRuntime._layoutManager._layoutsByName.get("game")._layersByName.get("ui")._instances[3]._sdkInst._SetText(String(O[1])),O[0]>=T)return O=[0,0],globalVars.p1Score=T;if(O[1]>=T)return O=[0,0],globalVars.p2Score=T;globalVars.p1Score=0,globalVars.p2Score=0}setTimeout(()=>{c3_runtimeInterface._localRuntime._layoutManager._layoutsByName.get("game")._layersByName.get("ui")._instances[2]._sdkInst._SetText(String(O[0])),c3_runtimeInterface._localRuntime._layoutManager._layoutsByName.get("game")._layersByName.get("ui")._instances[3]._sdkInst._SetText(String(O[1]))},2450)}return i[0].originalUrl==="start"&&Promise.allSettled([C3Audio_DOMInterface._Play({vol:1,url:"media/remix0.webm",originalUrl:"remix0",tags:["music"],loop:!0}).then(()=>C3Audio_DOMInterface._Stop({url:"media/remix0.webm",originalUrl:"remix0",tags:["music"]})),C3Audio_DOMInterface._Play({vol:1,url:"media/remix1.webm",originalUrl:"remix1",tags:["music"],loop:!0}).then(()=>C3Audio_DOMInterface._Stop({url:"media/remix1.webm",originalUrl:"remix1",tags:["music"]})),C3Audio_DOMInterface._Play({vol:1,url:"media/remix2.webm",originalUrl:"remix2",tags:["music"],loop:!0}).then(()=>C3Audio_DOMInterface._Stop({url:"media/remix2.webm",originalUrl:"remix2",tags:["music"]}))]).then(se),i[0].originalUrl==="music"&&he(),i[0].originalUrl==="refsoc"&&(console.timeEnd(),oe()),d.apply(a,i)}})});window.bopMusic=async function(a){window.ball.instVars.hold=0,window.ball.instVars.who=-1,window.ball.x=1e3,window.ball.y=1e3;let i=[];return setTimeout(async()=>{const e=await fetch("./media/"+a+".webm").then(S=>S.arrayBuffer()).then(S=>new OfflineAudioContext(1,1,44100).decodeAudioData(S)),{tempo:t,bpm:s,offset:o}=await Q(e),u=60/s*1e3,h={vol:1,originalUrl:a,url:window.C3Audio_DOMInterface._audioBuffers.find(S=>S._originalUrl===a)._url,tags:["music"],isLooping:!0,isMusic:!1,off:0,pos:0,stereoPan:0,trueClock:!0};i.push(setInterval(()=>{c3_runtimeInterface._localRuntime._layoutManager._layoutsByName.get("game").SetScale(1.16),setTimeout(()=>{c3_runtimeInterface._localRuntime._layoutManager._layoutsByName.get("game").SetScale(1)},u)},u*2)),i.push(setInterval(()=>{c3_runtimeInterface._localRuntime._layoutManager._layoutsByName.get("game")._layersByName.get("bg").SetAngle((Math.random()*6-3)*(Math.PI/180))},u)),i.push(setInterval(()=>{window.heads[0].angleDegrees<50&&(window.heads[0].angleDegrees=359),window.heads[1].angleDegrees<50&&(window.heads[1].angleDegrees=359),window.heads[2].angleDegrees<50&&(window.heads[2].angleDegrees=359),window.heads[3].angleDegrees<50&&(window.heads[3].angleDegrees=359)}));let m=-15,v=.06;i.push(setInterval(()=>{m+=v,m>=15?v=-.06:m<=-15&&(v=.06);for(var S of window.players)S.instVars.angular=m},1)),C3Audio_DOMInterface._StopAll(),window.C3Audio_DOMInterface._Play(h),window._stopBop=!0},1450),window._stopBop=!1,window.stopBop=async function(){if(!window._stopBop)for(;!window._stopBop;)await new Promise(s=>setTimeout(s,100));for(var t of i)clearInterval(t);window.C3Audio_DOMInterface._Stop({url:`media/${a}.webm`,originalUrl:a,tags:["music"]}),window.ball.instVars.hold=0,window.ball.instVars.who=-1,window.ball.x=1e3,window.ball.y=1e3},!0};window.WebGLRenderingContext.prototype.drawElements=null;window.WebGL2RenderingContext=null;window.basketLoading.then(()=>setInterval(()=>{const d=window.ball;G===!0&&(d.x>225&&d.y>75&&d.y<80&&Z(),d.x<80&&d.y>75&&d.y<80&&Z());let a=0,i=0,e=0,t=0;function s(h){var m=c3_runtimeInterface._localRuntime._iRuntime.objects["body"+(h===0?"":h)].getAllInstances()[0],v=c3_runtimeInterface._localRuntime._iRuntime.objects["head"+(h===0?"":h)].getAllInstances()[0];c3_runtimeInterface._localRuntime._iRuntime.objects["arm"+(h===0?"":h)].getAllInstances()[0],a=m.x,i=m.y,e=v.x,t=v.y;let S=0,R=setInterval(()=>{S++,m.x=a,m.y=i,v.x=e,v.y=t,S>=3e6&&clearInterval(R)})}for(var[o,u]of enumerate(window.heads))(o===0||o===1)&&d.instVars.who===o+1&&u.x<80&&u.y>75&&u.y<80&&u.x>60&&s(o),(o===2||o===3)&&d.instVars.who===o+1&&u.x>225&&u.y>75&&u.y<80&&u.x<245&&s(o)},0));[30].forEach((d,a)=>{document.getElementById(`capture-${d}s`)._nativeEventListener("click",async()=>{F.saveClip()})});{class d{constructor(){this._broadcastChannel=typeof BroadcastChannel>"u"?null:new BroadcastChannel("offline"),this._queuedMessages=[],this._onMessageCallback=null,this._broadcastChannel&&(this._broadcastChannel.onmessage=i=>this._OnBroadcastChannelMessage(i))}_OnBroadcastChannelMessage(i){if(this._onMessageCallback){this._onMessageCallback(i);return}this._queuedMessages.push(i)}SetMessageCallback(i){this._onMessageCallback=i;for(let e of this._queuedMessages)this._onMessageCallback(e);this._queuedMessages.length=0}}window.OfflineClientInfo=new d}window.DOMHandler=class{constructor(a,i){this._iRuntime=a,this._componentId=i,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(a,i,e,t){this._iRuntime.PostToRuntimeComponent(this._componentId,a,i,e,t)}PostToRuntimeAsync(a,i,e,t){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,a,i,e,t)}_PostToRuntimeMaybeSync(a,i,e){this._iRuntime.UsesWorker()?this.PostToRuntime(a,i,e):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",component:this._componentId,handler:a,dispatchOpts:e||null,data:i,responseId:null})}AddRuntimeMessageHandler(a,i){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,a,i)}AddRuntimeMessageHandlers(a){for(const[i,e]of a)this.AddRuntimeMessageHandler(i,e)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}},window.RateLimiter=class{constructor(a,i){this._callback=a,this._interval=i,this._timerId=-1,this._lastCallTime=-1/0,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1}SetCanRunImmediate(a){this._canRunImmediate=!!a}Call(){if(this._timerId!==-1)return;const a=Date.now(),i=a-this._lastCallTime,e=this._interval;i>=e&&this._canRunImmediate?(this._lastCallTime=a,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(e-i,4))}_RunCallback(){this._ignoreReset=!0,this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1,this._lastCallTime=Date.now(),this._RunCallback()}_CancelTimer(){this._timerId!==-1&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._timerCallFunc=null}};{class d{constructor(i){this._elem=i,this._hadFirstUpdate=!1,this._isVisibleFlag=!0}SetVisibleFlag(i){this._isVisibleFlag=!!i}GetVisibleFlag(){return this._isVisibleFlag}HadFirstUpdate(){return this._hadFirstUpdate}SetHadFirstUpdate(){this._hadFirstUpdate=!0}GetElement(){return this._elem}}window.DOMElementHandler=class extends self.DOMHandler{constructor(i,e){super(i,e),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandlers([["create",t=>this._OnCreate(t)],["destroy",t=>this._OnDestroy(t)],["set-visible",t=>this._OnSetVisible(t)],["update-position",t=>this._OnUpdatePosition(t)],["update-state",t=>this._OnUpdateState(t)],["focus",t=>this._OnSetFocus(t)],["set-css-style",t=>this._OnSetCssStyle(t)],["set-attribute",t=>this._OnSetAttribute(t)],["remove-attribute",t=>this._OnRemoveAttribute(t)]]),this.AddDOMElementMessageHandler("get-element",t=>t)}SetAutoAttach(i){this._autoAttach=!!i}AddDOMElementMessageHandler(i,e){this.AddRuntimeMessageHandler(i,t=>{const s=t.elementId,o=this.GetElementById(s);return e(o,t)})}_OnCreate(i){const e=i.elementId,t=this.CreateElement(e,i),s=new d(t);this._elementMap.set(e,s),t.style.boxSizing="border-box",t.style.display="none",s.SetVisibleFlag(i.isVisible);const o=this._GetFocusElement(t);o.addEventListener("focus",u=>this._OnFocus(e)),o.addEventListener("blur",u=>this._OnBlur(e)),this._autoAttach&&document.body.appendChild(t)}CreateElement(i,e){throw new Error("required override")}DestroyElement(i){}_OnDestroy(i){const e=i.elementId,t=this.GetElementById(e);this.DestroyElement(t),this._autoAttach&&t.parentElement.removeChild(t),this._elementMap.delete(e)}PostToRuntimeElement(i,e,t){t||(t={}),t.elementId=e,this.PostToRuntime(i,t)}_PostToRuntimeElementMaybeSync(i,e,t){t||(t={}),t.elementId=e,this._PostToRuntimeMaybeSync(i,t)}_OnSetVisible(i){if(!this._autoAttach)return;const e=this._elementMap.get(i.elementId),t=e.GetElement();e.HadFirstUpdate()?t.style.display=i.isVisible?"":"none":e.SetVisibleFlag(i.isVisible)}_OnUpdatePosition(i){if(!this._autoAttach)return;const e=this._elementMap.get(i.elementId),t=e.GetElement();t.style.left=i.left+"px",t.style.top=i.top+"px",t.style.width=i.width+"px",t.style.height=i.height+"px";const s=i.fontSize;s!==null&&(t.style.fontSize=s+"em"),e.HadFirstUpdate()||(e.SetHadFirstUpdate(),e.GetVisibleFlag()&&(t.style.display=""))}_OnUpdateState(i){const e=this.GetElementById(i.elementId);this.UpdateState(e,i)}UpdateState(i,e){throw new Error("required override")}_GetFocusElement(i){return i}_OnFocus(i){this.PostToRuntimeElement("elem-focused",i)}_OnBlur(i){this.PostToRuntimeElement("elem-blurred",i)}_OnSetFocus(i){const e=this._GetFocusElement(this.GetElementById(i.elementId));i.focus?e.focus():e.blur()}_OnSetCssStyle(i){const e=this.GetElementById(i.elementId),t=i.prop,s=i.val;t.startsWith("--")?e.style.setProperty(t,s):e.style[t]=s}_OnSetAttribute(i){this.GetElementById(i.elementId).setAttribute(i.name,i.val)}_OnRemoveAttribute(i){this.GetElementById(i.elementId).removeAttribute(i.name)}GetElementById(i){const e=this._elementMap.get(i);if(!e)throw new Error(`no element with id ${i}`);return e.GetElement()}}}{let t=function(r){const n=document.createElement("script");return n.async=!1,n.type="module",r.isStringSrc?new Promise(l=>{const c="c3_resolve_"+e;++e,self[c]=l,n.textContent=r.str+`

self["${c}"]();`,document.head.appendChild(n)}):new Promise((l,c)=>{n.onload=l,n.onerror=c,n.src=r,document.head.appendChild(n)})},u=function(){if(!s){try{new Worker("blob://",{get type(){o=!0}})}catch{}s=!0}return o},S=function(r){return new Promise((n,l)=>{const c=new FileReader;c.onload=_=>n(_.target.result),c.onerror=_=>l(_),c.readAsArrayBuffer(r)})},U=function(r){return K.has(r)};const d=/(iphone|ipod|ipad|macos|macintosh|mac os x)/i.test(navigator.userAgent),a=/android/i.test(navigator.userAgent),i=/safari/i.test(navigator.userAgent)&&!/(chrome|chromium|edg\/|OPR\/|nwjs)/i.test(navigator.userAgent);let e=0,s=!1,o=!1,h=new Audio;const m={"audio/webm; codecs=opus":!!h.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!h.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!h.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!h.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!h.canPlayType("audio/mp4"),"audio/mpeg":!!h.canPlayType("audio/mpeg")};h=null;async function v(r){const n=await S(r);return new TextDecoder("utf-8").decode(n)}const R=[];let A=0;const k=8;window.RealFile=window.File;const P=[],D=new Map,N=new Map;let Y=0;const W=[];self.runOnStartup=function(n){if(typeof n!="function")throw new Error("runOnStartup called without a function");W.push(n)};const K=new Set(["cordova","playable-ad","instant-games"]);let g=!1;window.RuntimeInterface=class j{constructor(n){if(this._useWorker=n.useWorker,this._messageChannelPort=null,this._runtimeBaseUrl="",this._scriptFolder=n.scriptFolder,this._workerScriptURLs={},this._worker=null,this._localRuntime=null,this._domHandlers=[],this._runtimeDomHandler=null,this._canvas=null,this._isExportingToVideo=!1,this._exportToVideoDuration=0,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=[],this._wrapperInitResolve=null,this._wrapperComponentIds=[],this._exportType=n.exportType,this._isFileProtocol=location.protocol.substr(0,4)==="file",this._useWorker&&(typeof OffscreenCanvas>"u"||!navigator.userActivation||!u())&&(this._useWorker=!1),this._useWorker&&i&&(this._useWorker=!1),(this._exportType==="playable-ad"||this._exportType==="instant-games")&&(this._useWorker=!1),this._exportType==="cordova"&&this._useWorker)if(a){const l=/Chrome\/(\d+)/i.exec(navigator.userAgent);(!l||!(parseInt(l[1],10)>=90))&&(this._useWorker=!1)}else this._useWorker=!1;this.IsWebView2Wrapper()?self.chrome.webview.addEventListener("message",l=>this._OnWrapperMessage(l.data)):this._exportType==="macos-wkwebview"&&(self.C3WrapperOnMessage=l=>this._OnWrapperMessage(l)),this._localFileBlobs=null,this._localFileStrings=null,this._exportType==="html5"&&!window.isSecureContext&&console.warn("[Construct] Warning: the browser indicates this is not a secure context. Some features may be unavailable. Use secure (HTTPS) hosting to ensure all features are available."),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",l=>this._OnCordovaFetchLocalFile(l)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",l=>this._OnCreateJobWorker(l)),this.AddRuntimeComponentMessageHandler("runtime","send-wrapper-extension-message",l=>this._OnSendWrapperExtensionMessage(l)),this._exportType==="cordova"?document.addEventListener("deviceready",()=>this._Init(n)):this._Init(n)}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort.onmessage=null,this._messageChannelPort=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null),this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=null)}GetCanvas(){return this._canvas}GetRuntimeBaseURL(){return this._runtimeBaseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsFileProtocol(){return this._isFileProtocol}GetScriptFolder(){return this._scriptFolder}IsiOSCordova(){return d&&this._exportType==="cordova"}IsiOSWebView(){const n=navigator.userAgent;return d&&U(this._exportType)||navigator.standalone||/crios\/|fxios\/|edgios\//i.test(n)}IsAndroid(){return a}IsAndroidWebView(){return a&&U(this._exportType)}IsWebView2Wrapper(){return this._exportType==="windows-webview2"||!!(this._exportType==="preview"&&window.chrome&&window.chrome.webview&&window.chrome.webview.postMessage)}async _Init(n){if(this._exportType==="macos-wkwebview")this._SendWrapperMessage({type:"ready"});else if(this.IsWebView2Wrapper()){this._SetupWebView2Polyfills();const c=await this._InitWrapper();this._wrapperComponentIds=c.registeredComponentIds}if(this._exportType==="playable-ad"){this._localFileBlobs=self.c3_base64files,this._localFileStrings={},await this._ConvertDataUrisToBlobs();for(let c=0,_=n.engineScripts.length;c<_;++c){const p=n.engineScripts[c];this._localFileStrings.hasOwnProperty(p)?n.engineScripts[c]={isStringSrc:!0,str:this._localFileStrings[p]}:this._localFileBlobs.hasOwnProperty(p)&&(n.engineScripts[c]=URL.createObjectURL(this._localFileBlobs[p]))}n.workerDependencyScripts=[]}if(this._exportType==="nwjs"&&self.nw&&self.nw.App.manifest["c3-steam-mode"]){let c=0;this._AddRAFCallback(()=>{c++,document.body.style.opacity=c%2===0?"1":"0.999"})}if(n.runtimeBaseUrl)this._runtimeBaseUrl=n.runtimeBaseUrl;else{const c=location.origin;this._runtimeBaseUrl=(c==="null"?"file:///":c)+location.pathname;const _=this._runtimeBaseUrl.lastIndexOf("/");_!==-1&&(this._runtimeBaseUrl=this._runtimeBaseUrl.substr(0,_+1))}n.workerScripts&&(this._workerScriptURLs=n.workerScripts);const l=new MessageChannel;if(this._messageChannelPort=l.port1,this._messageChannelPort.onmessage=c=>this._OnMessageFromRuntime(c.data),window.c3_addPortMessageHandler&&window.c3_addPortMessageHandler(c=>this._OnMessageFromDebugger(c)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),typeof window.StatusBar=="object"&&window.StatusBar.hide(),typeof window.AndroidFullScreen=="object")try{await new Promise((c,_)=>{window.AndroidFullScreen.immersiveMode(c,_)})}catch(c){console.error("Failed to enter Android immersive mode: ",c)}this._useWorker?await this._InitWorker(n,l.port2):await this._InitDOM(n,l.port2)}_GetWorkerURL(n){let l;return this._workerScriptURLs.hasOwnProperty(n)?l=this._workerScriptURLs[n]:n.endsWith("/workermain.js")&&this._workerScriptURLs.hasOwnProperty("workermain.js")?l=this._workerScriptURLs["workermain.js"]:this._exportType==="playable-ad"&&this._localFileBlobs.hasOwnProperty(n)?l=this._localFileBlobs[n]:l=n,l instanceof Blob&&(l=URL.createObjectURL(l)),l}async CreateWorker(n,l,c){if(n.startsWith("blob:"))return new Worker(n,c);if(this._exportType==="cordova"&&this._isFileProtocol){let y="";c.isC3MainWorker?y=n:y=this._scriptFolder+n;const w=await this.CordovaFetchLocalFileAsArrayBuffer(y),f=new Blob([w],{type:"application/javascript"});return new Worker(URL.createObjectURL(f),c)}const _=new URL(n,l);if(location.origin!==_.origin){const y=await fetch(_);if(!y.ok)throw new Error("failed to fetch worker script");const w=await y.blob();return new Worker(URL.createObjectURL(w),c)}else return new Worker(_,c)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}_GetCommonRuntimeOptions(n){return{runtimeBaseUrl:this._runtimeBaseUrl,previewUrl:location.href,windowInnerWidth:this._GetWindowInnerWidth(),windowInnerHeight:this._GetWindowInnerHeight(),devicePixelRatio:window.devicePixelRatio,isFullscreen:j.IsDocumentFullscreen(),projectData:n.projectData,previewImageBlobs:window.cr_previewImageBlobs||this._localFileBlobs,previewProjectFileBlobs:window.cr_previewProjectFileBlobs,previewProjectFileSWUrls:window.cr_previewProjectFiles,swClientId:window.cr_swClientId||"",exportType:n.exportType,isDebug:new URLSearchParams(self.location.search).has("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),supportedAudioFormats:m,opusWasmScriptUrl:window.cr_opusWasmScriptUrl||this._scriptFolder+"opus.wasm.js",opusWasmBinaryUrl:window.cr_opusWasmBinaryUrl||this._scriptFolder+"opus.wasm.wasm",isFileProtocol:this._isFileProtocol,isiOSCordova:this.IsiOSCordova(),isiOSWebView:this.IsiOSWebView(),isWebView2Wrapper:this.IsWebView2Wrapper(),wrapperComponentIds:this._wrapperComponentIds,isFBInstantAvailable:typeof self.FBInstant<"u"}}async _InitWorker(n,l){const c=this._GetWorkerURL(n.workerMainUrl);this._exportType==="preview"?(this._worker=new Worker("previewworker.js",{type:"module",name:"Runtime"}),await new Promise((w,f)=>{const b=E=>{this._worker.removeEventListener("message",b),E.data&&E.data.type==="ok"?w():f()};this._worker.addEventListener("message",b),this._worker.postMessage({type:"construct-worker-init",import:new URL(c,this._runtimeBaseUrl).toString()})})):this._worker=await this.CreateWorker(c,this._runtimeBaseUrl,{type:"module",name:"Runtime",isC3MainWorker:!0}),this._canvas=document.createElement("canvas"),this._canvas.style.display="none";const _=this._canvas.transferControlToOffscreen();document.body.appendChild(this._canvas),window.c3canvas=this._canvas,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders();let p=n.workerDependencyScripts||[],y=n.engineScripts;if(p=await Promise.all(p.map(w=>this._MaybeGetCordovaScriptURL(w))),y=await Promise.all(y.map(w=>this._MaybeGetCordovaScriptURL(w))),this._exportType==="cordova")for(let w=0,f=n.projectScripts.length;w<f;++w){const b=n.projectScripts[w],E=b[0];(E===n.mainProjectScript||E==="scriptsInEvents.js"||E.endsWith("/scriptsInEvents.js"))&&(b[1]=await this._MaybeGetCordovaScriptURL(E))}this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(n),{type:"init-runtime",isInWorker:!0,messagePort:l,canvas:_,workerDependencyScripts:p,engineScripts:y,projectScripts:n.projectScripts,mainProjectScript:n.mainProjectScript,projectScriptsStatus:self.C3_ProjectScriptsStatus}),[l,_,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=P.map(w=>new w(this)),this._FindRuntimeDOMHandler(),this._runtimeDomHandler._EnableWindowResizeEvent(),self.c3_callFunction=(w,f)=>this._runtimeDomHandler._InvokeFunctionFromJS(w,f),this._exportType==="preview"&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(n,l){this._canvas=document.createElement("canvas"),this._canvas.style.display="none",document.body.appendChild(this._canvas),window.c3canvas=this._canvas,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders(),this._domHandlers=P.map(f=>new f(this)),this._FindRuntimeDOMHandler();let c=n.engineScripts.map(f=>typeof f=="string"?new URL(f,this._runtimeBaseUrl).toString():f);if(Array.isArray(n.workerDependencyScripts)){const f=[...n.workerDependencyScripts].map(b=>b instanceof Blob?URL.createObjectURL(b):b);c.unshift(...f)}c=await Promise.all(c.map(f=>this._MaybeGetCordovaScriptURL(f))),await Promise.all(c.map(f=>t(f)));const _=self.C3_ProjectScriptsStatus,p=n.mainProjectScript,y=n.projectScripts;for(let[f,b]of y)if(b||(b=f),f===p)try{b=await this._MaybeGetCordovaScriptURL(b),await t(b),this._exportType==="preview"&&!_[f]&&this._ReportProjectMainScriptError(f,"main script did not run to completion")}catch(E){this._ReportProjectMainScriptError(f,E)}else(f==="scriptsInEvents.js"||f.endsWith("/scriptsInEvents.js"))&&(b=await this._MaybeGetCordovaScriptURL(b),await t(b));if(this._exportType==="preview"&&typeof self.C3.ScriptsInEvents!="object"){this._RemoveLoadingMessage();const f="Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.";console.error("[C3 runtime] "+f),alert(f);return}const w=Object.assign(this._GetCommonRuntimeOptions(n),{isInWorker:!1,messagePort:l,canvas:this._canvas,runOnStartupFunctions:W});this._runtimeDomHandler._EnableWindowResizeEvent(),this._OnBeforeCreateRuntime(),this._localRuntime=self.C3_CreateRuntime(w),await self.C3_InitRuntime(this._localRuntime,w)}_ReportProjectMainScriptError(n,l){this._RemoveLoadingMessage(),console.error(`[Preview] Failed to load project main script (${n}): `,l),alert(`Failed to load project main script (${n}). Check all your JavaScript code has valid syntax. Press F12 and check the console for error details.`)}_OnBeforeCreateRuntime(){this._RemoveLoadingMessage()}_RemoveLoadingMessage(){const n=window.cr_previewLoadingElem;n&&(n.parentElement.removeChild(n),window.cr_previewLoadingElem=null)}async _OnCreateJobWorker(n){const l=await this._jobScheduler._CreateJobWorker();return{outputPort:l,transferables:[l]}}_GetLocalRuntime(){if(this._useWorker)throw new Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(n,l,c,_,p){this._messageChannelPort.postMessage({type:"event",component:n,handler:l,dispatchOpts:_||null,data:c,responseId:null},p)}PostToRuntimeComponentAsync(n,l,c,_,p){const y=Y++,w=new Promise((f,b)=>{N.set(y,{resolve:f,reject:b})});return this._messageChannelPort.postMessage({type:"event",component:n,handler:l,dispatchOpts:_||null,data:c,responseId:y},p),w}_OnMessageFromRuntime(n){const l=n.type;if(l==="event")return this._OnEventFromRuntime(n);if(l==="result")this._OnResultFromRuntime(n);else if(l==="runtime-ready")this._OnRuntimeReady();else if(l==="alert-error")this._RemoveLoadingMessage(),alert(n.message);else if(l==="creating-runtime")this._OnBeforeCreateRuntime();else throw new Error(`unknown message '${l}'`)}_OnEventFromRuntime(n){const l=n.component,c=n.handler,_=n.data,p=n.responseId,y=D.get(l);if(!y){console.warn(`[DOM] No event handlers for component '${l}'`);return}const w=y.get(c);if(!w){console.warn(`[DOM] No handler '${c}' for component '${l}'`);return}let f=null;try{f=w(_)}catch(b){console.error(`Exception in '${l}' handler '${c}':`,b),p!==null&&this._PostResultToRuntime(p,!1,""+b);return}if(p===null)return f;f&&f.then?f.then(b=>this._PostResultToRuntime(p,!0,b)).catch(b=>{console.error(`Rejection from '${l}' handler '${c}':`,b),this._PostResultToRuntime(p,!1,""+b)}):this._PostResultToRuntime(p,!0,f)}_PostResultToRuntime(n,l,c){let _;c&&c.transferables&&(_=c.transferables),this._messageChannelPort.postMessage({type:"result",responseId:n,isOk:l,result:c},_)}_OnResultFromRuntime(n){const l=n.responseId,c=n.isOk,_=n.result,p=N.get(l);c?p.resolve(_):p.reject(_),N.delete(l)}AddRuntimeComponentMessageHandler(n,l,c){let _=D.get(n);if(_||(_=new Map,D.set(n,_)),_.has(l))throw new Error(`[DOM] Component '${n}' already has handler '${l}'`);_.set(l,c)}static AddDOMHandlerClass(n){if(P.includes(n))throw new Error("DOM handler already added");P.push(n)}_FindRuntimeDOMHandler(){for(const n of this._domHandlers)if(n.GetComponentID()==="runtime"){this._runtimeDomHandler=n;return}throw new Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(n){this.PostToRuntimeComponent("debugger","message",n)}_OnRuntimeReady(){for(const n of this._domHandlers)n.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||g)}static _SetWrapperIsFullscreenFlag(n){g=!!n}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(n){this._rafCallbacks.push(n),this._RequestAnimationFrame()}_RemoveRAFCallback(n){const l=this._rafCallbacks.indexOf(n);if(l===-1)throw new Error("invalid callback");this._rafCallbacks.splice(l,1),this._rafCallbacks.length||this._CancelAnimationFrame()}_RequestAnimationFrame(){this._rafId===-1&&this._rafCallbacks.length&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){this._rafId!==-1&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const n of this._rafCallbacks)n();this._RequestAnimationFrame()}TryPlayMedia(n){this._runtimeDomHandler.TryPlayMedia(n)}RemovePendingPlay(n){this._runtimeDomHandler.RemovePendingPlay(n)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(n){this._runtimeDomHandler.SetSilent(n)}IsAudioFormatSupported(n){return!!m[n]}async _WasmDecodeWebMOpus(n){const l=await this.PostToRuntimeComponentAsync("runtime","opus-decode",{arrayBuffer:n},null,[n]);return new Float32Array(l)}SetIsExportingToVideo(n){this._isExportingToVideo=!0,this._exportToVideoDuration=n}IsExportingToVideo(){return this._isExportingToVideo}GetExportToVideoDuration(){return this._exportToVideoDuration}IsAbsoluteURL(n){return/^(?:[a-z\-]+:)?\/\//.test(n)||n.substr(0,5)==="data:"||n.substr(0,5)==="blob:"}IsRelativeURL(n){return!this.IsAbsoluteURL(n)}async _MaybeGetCordovaScriptURL(n){if(this._exportType==="cordova"&&(n.startsWith("file:")||this._isFileProtocol&&this.IsRelativeURL(n))){let l=n;l.startsWith(this._runtimeBaseUrl)&&(l=l.substr(this._runtimeBaseUrl.length));const c=await this.CordovaFetchLocalFileAsArrayBuffer(l),_=new Blob([c],{type:"application/javascript"});return URL.createObjectURL(_)}else return n}async _OnCordovaFetchLocalFile(n){const l=n.filename;switch(n.as){case"text":return await this.CordovaFetchLocalFileAsText(l);case"buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(l);default:throw new Error("unsupported type")}}_GetPermissionAPI(){const n=window.cordova&&window.cordova.plugins&&window.cordova.plugins.permissions;if(typeof n!="object")throw new Error("Permission API is not loaded");return n}_MapPermissionID(n,l){const c=n[l];if(typeof c!="string")throw new Error("Invalid permission name");return c}_HasPermission(n){const l=this._GetPermissionAPI();return new Promise((c,_)=>l.checkPermission(this._MapPermissionID(l,n),p=>c(!!p.hasPermission),_))}_RequestPermission(n){const l=this._GetPermissionAPI();return new Promise((c,_)=>l.requestPermission(this._MapPermissionID(l,n),p=>c(!!p.hasPermission),_))}async RequestPermissions(n){if(this.GetExportType()!=="cordova"||this.IsiOSCordova())return!0;for(const l of n){if(await this._HasPermission(l))continue;if(await this._RequestPermission(l)===!1)return!1}return!0}async RequirePermissions(...n){if(await this.RequestPermissions(n)===!1)throw new Error("Permission not granted")}CordovaFetchLocalFile(n){const l=window.cordova.file.applicationDirectory+"www/"+n;return new Promise((c,_)=>{window.resolveLocalFileSystemURL(l,p=>{p.file(c,_)},_)})}async CordovaFetchLocalFileAsText(n){const l=await this.CordovaFetchLocalFile(n);return await v(l)}_CordovaMaybeStartNextArrayBufferRead(){if(!R.length||A>=k)return;A++;const n=R.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(n.filename,n.successCallback,n.errorCallback)}CordovaFetchLocalFileAsArrayBuffer(n){return new Promise((l,c)=>{R.push({filename:n,successCallback:_=>{A--,this._CordovaMaybeStartNextArrayBufferRead(),l(_)},errorCallback:_=>{A--,this._CordovaMaybeStartNextArrayBufferRead(),c(_)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(n,l,c){try{const _=await this.CordovaFetchLocalFile(n),p=await S(_);l(p)}catch(_){c(_)}}_OnWrapperMessage(n){if(n==="entered-fullscreen")j._SetWrapperIsFullscreenFlag(!0),this._runtimeDomHandler._OnFullscreenChange();else if(n==="exited-fullscreen")j._SetWrapperIsFullscreenFlag(!1),this._runtimeDomHandler._OnFullscreenChange();else if(typeof n=="object"){const l=n.type;l==="wrapper-init-response"?(this._wrapperInitResolve(n),this._wrapperInitResolve=null):l==="extension-message"?this.PostToRuntimeComponent("runtime","wrapper-extension-message",n):console.warn("Unknown wrapper message: ",n)}else console.warn("Unknown wrapper message: ",n)}_OnSendWrapperExtensionMessage(n){this._SendWrapperMessage({type:"extension-message",componentId:n.componentId,messageId:n.messageId,params:n.params||[],asyncId:n.asyncId})}_SendWrapperMessage(n){this.IsWebView2Wrapper()?window.chrome.webview.postMessage(JSON.stringify(n)):this._exportType==="macos-wkwebview"&&window.webkit.messageHandlers.C3Wrapper.postMessage(JSON.stringify(n))}_SetupWebView2Polyfills(){window.moveTo=(n,l)=>{this._SendWrapperMessage({type:"set-window-position",windowX:Math.ceil(n),windowY:Math.ceil(l)})},window.resizeTo=(n,l)=>{this._SendWrapperMessage({type:"set-window-size",windowWidth:Math.ceil(n),windowHeight:Math.ceil(l)})}}_InitWrapper(){return this.IsWebView2Wrapper()?new Promise(n=>{this._wrapperInitResolve=n,this._SendWrapperMessage({type:"wrapper-init"})}):Promise.resolve()}async _ConvertDataUrisToBlobs(){const n=[];for(const[l,c]of Object.entries(this._localFileBlobs))n.push(this._ConvertDataUriToBlobs(l,c));await Promise.all(n)}async _ConvertDataUriToBlobs(n,l){if(typeof l=="object")this._localFileBlobs[n]=new Blob([l.str],{type:l.type}),this._localFileStrings[n]=l.str;else{let c=await this._FetchDataUri(l);c||(c=this._DataURIToBinaryBlobSync(l)),this._localFileBlobs[n]=c}}async _FetchDataUri(n){try{return await(await fetch(n)).blob()}catch(l){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",l),null}}_DataURIToBinaryBlobSync(n){const l=this._ParseDataURI(n);return this._BinaryStringToBlob(l.data,l.mime_type)}_ParseDataURI(n){const l=n.indexOf(",");if(l<0)throw new URIError("expected comma in data: uri");const c=n.substring(5,l),_=n.substring(l+1),p=c.split(";"),y=p[0]||"",w=p[1],f=p[2];let b;return w==="base64"||f==="base64"?b=atob(_):b=decodeURIComponent(_),{mime_type:y,data:b}}_BinaryStringToBlob(n,l){let c=n.length,_=c>>2,p=new Uint8Array(c),y=new Uint32Array(p.buffer,0,_),w,f;for(w=0,f=0;w<_;++w)y[w]=n.charCodeAt(f++)|n.charCodeAt(f++)<<8|n.charCodeAt(f++)<<16|n.charCodeAt(f++)<<24;let b=c&3;for(;b--;)p[f]=n.charCodeAt(f),++f;return new Blob([p],{type:l})}}}{let a=function(g){return g.sourceCapabilities&&g.sourceCapabilities.firesTouchEvents||g.originalEvent&&g.originalEvent.sourceCapabilities&&g.originalEvent.sourceCapabilities.firesTouchEvents},o=function(g){return new Promise((r,n)=>{const l=document.createElement("link");l.onload=()=>r(l),l.onerror=c=>n(c),l.rel="stylesheet",l.href=g,document.head.appendChild(l)})},u=function(g){return new Promise((r,n)=>{const l=new Image;l.onload=()=>r(l),l.onerror=c=>n(c),l.src=g})},m=function(g){return new Promise((r,n)=>{let l=new FileReader;l.onload=c=>r(c.target.result),l.onerror=c=>n(c),l.readAsText(g)})},S=function(g){do{if(g.parentNode&&g.hasAttribute("contenteditable"))return!0;g=g.parentNode}while(g);return!1},A=function(g){return R.has(g.tagName.toLowerCase())||S(g)},P=function(g){if(!g.target.tagName)return;const r=g.target.tagName.toLowerCase();k.has(r)&&g.preventDefault()},D=function(g){(g.metaKey||g.ctrlKey)&&g.preventDefault()},Y=function(){try{return window.parent&&window.parent.document.hasFocus()}catch{return!1}},W=function(){const g=document.activeElement;if(!g)return!1;const r=g.tagName.toLowerCase(),n=new Set(["email","number","password","search","tel","text","url"]);return r==="textarea"?!0:r==="input"?n.has(g.type.toLowerCase()||"text"):S(g)};const d=self.RuntimeInterface,i=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),e={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},t={dispatchUserScriptEvent:!0},s={dispatchRuntimeEvent:!0};async function h(g){const r=URL.createObjectURL(g);try{return await u(r)}finally{URL.revokeObjectURL(r)}}async function v(g,r,n){if(!/firefox/i.test(navigator.userAgent))return await h(g);let l=await m(g);const _=new DOMParser().parseFromString(l,"image/svg+xml"),p=_.documentElement;if(p.hasAttribute("width")&&p.hasAttribute("height")){const w=p.getAttribute("width"),f=p.getAttribute("height");if(!w.includes("%")&&!f.includes("%"))return await h(g)}return p.setAttribute("width",r+"px"),p.setAttribute("height",n+"px"),l=new XMLSerializer().serializeToString(_),g=new Blob([l],{type:"image/svg+xml"}),await h(g)}const R=new Set(["input","textarea","datalist","select"]),k=new Set(["canvas","body","html"]);self.C3_GetSvgImageSize=async function(g){const r=await h(g);if(r.width>0&&r.height>0)return[r.width,r.height];{r.style.position="absolute",r.style.left="0px",r.style.top="0px",r.style.visibility="hidden",document.body.appendChild(r);const n=r.getBoundingClientRect();return document.body.removeChild(r),[n.width,n.height]}},self.C3_RasterSvgImageBlob=async function(g,r,n,l,c){const _=await v(g,r,n),p=document.createElement("canvas");return p.width=l,p.height=c,p.getContext("2d").drawImage(_,0,0,r,n),p};let N=!1;document.addEventListener("pause",()=>N=!0),document.addEventListener("resume",()=>N=!1);const K="runtime",U=class extends self.DOMHandler{constructor(r){super(r,K),this._isFirstSizeUpdate=!0,this._enableWindowResizeEvent=!1,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._attachedDeviceOrientationEvent=!1,this._attachedDeviceMotionEvent=!1,this._pageVisibilityIsHidden=!1,this._screenReaderTextWrap=document.createElement("div"),this._screenReaderTextWrap.className="c3-screen-reader-text",this._screenReaderTextWrap.setAttribute("aria-live","polite"),document.body.appendChild(this._screenReaderTextWrap),this._debugHighlightElem=null,this._isExportToVideo=!1,this._exportVideoProgressMessage="",this._exportVideoUpdateTimerId=-1,this._enableAndroidVKDetection=!1,this._lastWindowWidth=r._GetWindowInnerWidth(),this._lastWindowHeight=r._GetWindowInnerHeight(),this._virtualKeyboardHeight=0,this._vkTranslateYOffset=0,r.AddRuntimeComponentMessageHandler("canvas","update-size",c=>this._OnUpdateCanvasSize(c)),r.AddRuntimeComponentMessageHandler("runtime","invoke-download",c=>this._OnInvokeDownload(c)),r.AddRuntimeComponentMessageHandler("runtime","load-webfonts",c=>this._OnLoadWebFonts(c)),r.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",c=>this._OnRasterSvgImage(c)),r.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",c=>this._OnGetSvgImageSize(c)),r.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",c=>this._OnSetTargetOrientation(c)),r.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),r.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",c=>this._OnPostToDebugger(c)),r.AddRuntimeComponentMessageHandler("runtime","go-to-script",c=>this._OnPostToDebugger(c)),r.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),r.AddRuntimeComponentMessageHandler("runtime","debug-highlight",c=>this._OnDebugHighlight(c)),r.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),r.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),r.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",c=>this._OnAddStylesheet(c)),r.AddRuntimeComponentMessageHandler("runtime","script-create-worker",c=>this._OnScriptCreateWorker(c)),r.AddRuntimeComponentMessageHandler("runtime","alert",c=>this._OnAlert(c)),r.AddRuntimeComponentMessageHandler("runtime","screen-reader-text",c=>this._OnScreenReaderTextEvent(c)),r.AddRuntimeComponentMessageHandler("runtime","hide-cordova-splash",()=>this._OnHideCordovaSplash()),r.AddRuntimeComponentMessageHandler("runtime","set-exporting-to-video",c=>this._SetExportingToVideo(c)),r.AddRuntimeComponentMessageHandler("runtime","export-to-video-progress",c=>this._OnExportVideoProgress(c)),r.AddRuntimeComponentMessageHandler("runtime","exported-to-video",c=>this._OnExportedToVideo(c)),r.AddRuntimeComponentMessageHandler("runtime","exported-to-image-sequence",c=>this._OnExportedToImageSequence(c));const n=new Set(["input","textarea","datalist"]);window.addEventListener("contextmenu",c=>{const _=c.target,p=_.tagName.toLowerCase();!n.has(p)&&!S(_)&&c.preventDefault()});const l=r.GetCanvas();if(window.addEventListener("selectstart",P),window.addEventListener("gesturehold",P),l.addEventListener("selectstart",P),l.addEventListener("gesturehold",P),window.addEventListener("touchstart",P,{passive:!1}),typeof PointerEvent<"u"?(window.addEventListener("pointerdown",P,{passive:!1}),l.addEventListener("pointerdown",P)):l.addEventListener("touchstart",P),this._mousePointerLastButtons=0,window.addEventListener("mousedown",c=>{c.button===1&&c.preventDefault()}),window.addEventListener("mousewheel",D,{passive:!1}),window.addEventListener("wheel",D,{passive:!1}),window.addEventListener("resize",()=>this._OnWindowResize()),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",c=>this._OnFullscreenError(c)),window.addEventListener("webkitfullscreenerror",c=>this._OnFullscreenError(c)),window.addEventListener("mozfullscreenerror",c=>this._OnFullscreenError(c)),r.IsiOSWebView())if(window.visualViewport){let c=1/0;window.visualViewport.addEventListener("resize",()=>{const _=window.visualViewport.height;_>c&&(document.scrollingElement.scrollTop=0),c=_})}else window.addEventListener("focusout",()=>{W()||(document.scrollingElement.scrollTop=0)});this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_OnBeforeStartTicking(){return self.setTimeout(()=>{this._enableAndroidVKDetection=!0},1e3),this._iRuntime.GetExportType()==="cordova"?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.visibilityState==="hidden")),this._pageVisibilityIsHidden=!!(document.visibilityState==="hidden"||N),{isSuspended:this._pageVisibilityIsHidden}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:Y()}),this._mousePointerLastButtons=0}),window.addEventListener("focusin",n=>{A(n.target)&&this._PostRuntimeEvent("keyboard-blur")}),window.addEventListener("keydown",n=>this._OnKeyEvent("keydown",n)),window.addEventListener("keyup",n=>this._OnKeyEvent("keyup",n)),window.addEventListener("dblclick",n=>this._OnMouseEvent("dblclick",n,e)),window.addEventListener("wheel",n=>this._OnMouseWheelEvent("wheel",n)),typeof PointerEvent<"u"?(window.addEventListener("pointerdown",n=>{this._HandlePointerDownFocus(n),this._OnPointerEvent("pointerdown",n)}),this._iRuntime.UsesWorker()&&typeof window.onpointerrawupdate<"u"&&self===self.top?window.addEventListener("pointerrawupdate",n=>this._OnPointerRawUpdate(n)):window.addEventListener("pointermove",n=>this._OnPointerEvent("pointermove",n)),window.addEventListener("pointerup",n=>this._OnPointerEvent("pointerup",n)),window.addEventListener("pointercancel",n=>this._OnPointerEvent("pointercancel",n))):(window.addEventListener("mousedown",n=>{this._HandlePointerDownFocus(n),this._OnMouseEventAsPointer("pointerdown",n)}),window.addEventListener("mousemove",n=>this._OnMouseEventAsPointer("pointermove",n)),window.addEventListener("mouseup",n=>this._OnMouseEventAsPointer("pointerup",n)),window.addEventListener("touchstart",n=>{this._HandlePointerDownFocus(n),this._OnTouchEvent("pointerdown",n)}),window.addEventListener("touchmove",n=>this._OnTouchEvent("pointermove",n)),window.addEventListener("touchend",n=>this._OnTouchEvent("pointerup",n)),window.addEventListener("touchcancel",n=>this._OnTouchEvent("pointercancel",n)));const r=()=>this._PlayPendingMedia();window.addEventListener("pointerup",r,!0),window.addEventListener("touchend",r,!0),window.addEventListener("click",r,!0),window.addEventListener("keydown",r,!0),window.addEventListener("gamepadconnected",r,!0),this._iRuntime.IsAndroid()&&!this._iRuntime.IsAndroidWebView()&&navigator.virtualKeyboard&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",()=>{this._OnAndroidVirtualKeyboardChange(this._GetWindowInnerHeight(),navigator.virtualKeyboard.boundingRect.height)}))}_OnAndroidVirtualKeyboardChange(r,n){if(document.body.style.transform="",this._vkTranslateYOffset=0,n>0){const l=document.activeElement;if(l){const c=l.getBoundingClientRect(),_=(c.top+c.bottom)/2,p=(r-n)/2;let y=_-p;y>n&&(y=n),y<0&&(y=0),y>0&&(document.body.style.transform=`translateY(${-y}px)`,this._vkTranslateYOffset=y)}}}_PostRuntimeEvent(r,n){this.PostToRuntime(r,n||null,s)}_GetWindowInnerWidth(){return this._iRuntime._GetWindowInnerWidth()}_GetWindowInnerHeight(){return this._iRuntime._GetWindowInnerHeight()}_EnableWindowResizeEvent(){this._enableWindowResizeEvent=!0,this._lastWindowWidth=this._iRuntime._GetWindowInnerWidth(),this._lastWindowHeight=this._iRuntime._GetWindowInnerHeight()}_OnWindowResize(){if(this._isExportToVideo||!this._enableWindowResizeEvent)return;const r=this._GetWindowInnerWidth(),n=this._GetWindowInnerHeight();if(this._iRuntime.IsAndroidWebView())if(this._enableAndroidVKDetection)if(this._lastWindowWidth===r&&n<this._lastWindowHeight){this._virtualKeyboardHeight=this._lastWindowHeight-n,this._OnAndroidVirtualKeyboardChange(this._lastWindowHeight,this._virtualKeyboardHeight);return}else this._virtualKeyboardHeight>0&&(this._virtualKeyboardHeight=0,this._OnAndroidVirtualKeyboardChange(n,this._virtualKeyboardHeight)),this._lastWindowWidth=r,this._lastWindowHeight=n;else this._lastWindowWidth=r,this._lastWindowHeight=n;this.PostToRuntime("window-resize",{innerWidth:r,innerHeight:n,devicePixelRatio:window.devicePixelRatio,isFullscreen:d.IsDocumentFullscreen()}),this._iRuntime.IsiOSWebView()&&(this._simulatedResizeTimerId!==-1&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(r,n,0))}_ScheduleSimulatedResize(r,n,l){this._simulatedResizeTimerId!==-1&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(r,n,l),48)}_OnSimulatedResize(r,n,l){const c=this._GetWindowInnerWidth(),_=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1,c!=r||_!=n?this.PostToRuntime("window-resize",{innerWidth:c,innerHeight:_,devicePixelRatio:window.devicePixelRatio,isFullscreen:d.IsDocumentFullscreen()}):l<10&&this._ScheduleSimulatedResize(c,_,l+1)}_OnSetTargetOrientation(r){this._targetOrientation=r.targetOrientation}_TrySetTargetOrientation(){const r=this._targetOrientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(r).catch(n=>console.warn("[Construct] Failed to lock orientation: ",n));else try{let n=!1;screen.lockOrientation?n=screen.lockOrientation(r):screen.webkitLockOrientation?n=screen.webkitLockOrientation(r):screen.mozLockOrientation?n=screen.mozLockOrientation(r):screen.msLockOrientation&&(n=screen.msLockOrientation(r)),n||console.warn("[Construct] Failed to lock orientation")}catch(n){console.warn("[Construct] Failed to lock orientation: ",n)}}_OnFullscreenChange(){if(this._isExportToVideo)return;const r=d.IsDocumentFullscreen();r&&this._targetOrientation!=="any"&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{isFullscreen:r,innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnFullscreenError(r){console.warn("[Construct] Fullscreen request failed: ",r),this.PostToRuntime("fullscreenerror",{isFullscreen:d.IsDocumentFullscreen(),innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnVisibilityChange(r){this._pageVisibilityIsHidden!==r&&(this._pageVisibilityIsHidden=r,r?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{hidden:r}))}_OnKeyEvent(r,n){if(n.key==="Backspace"&&P(n),this._isExportToVideo)return;const l=i.get(n.code)||n.code;this._PostToRuntimeMaybeSync(r,{code:l,key:n.key,which:n.which,repeat:n.repeat,altKey:n.altKey,ctrlKey:n.ctrlKey,metaKey:n.metaKey,shiftKey:n.shiftKey,timeStamp:n.timeStamp},e)}_OnMouseWheelEvent(r,n){this._isExportToVideo||this.PostToRuntime(r,{clientX:n.clientX,clientY:n.clientY+this._vkTranslateYOffset,pageX:n.pageX,pageY:n.pageY+this._vkTranslateYOffset,deltaX:n.deltaX,deltaY:n.deltaY,deltaZ:n.deltaZ,deltaMode:n.deltaMode,timeStamp:n.timeStamp},e)}_OnMouseEvent(r,n,l){this._isExportToVideo||a(n)||this._PostToRuntimeMaybeSync(r,{button:n.button,buttons:n.buttons,clientX:n.clientX,clientY:n.clientY+this._vkTranslateYOffset,pageX:n.pageX,pageY:n.pageY+this._vkTranslateYOffset,movementX:n.movementX||0,movementY:n.movementY||0,timeStamp:n.timeStamp},l)}_OnMouseEventAsPointer(r,n){if(this._isExportToVideo||a(n))return;const l=1,c=this._mousePointerLastButtons;(r==="pointerdown"&&c!==0||r==="pointerup"&&n.buttons!==0)&&(r="pointermove"),this._PostToRuntimeMaybeSync(r,{pointerId:l,pointerType:"mouse",button:n.button,buttons:n.buttons,lastButtons:c,clientX:n.clientX,clientY:n.clientY+this._vkTranslateYOffset,pageX:n.pageX,pageY:n.pageY+this._vkTranslateYOffset,movementX:n.movementX||0,movementY:n.movementY||0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,timeStamp:n.timeStamp},e),this._mousePointerLastButtons=n.buttons,this._OnMouseEvent(n.type,n,t)}_OnPointerEvent(r,n){if(this._isExportToVideo)return;let l=0;if(n.pointerType==="mouse"&&(l=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(r,{pointerId:n.pointerId,pointerType:n.pointerType,button:n.button,buttons:n.buttons,lastButtons:l,clientX:n.clientX,clientY:n.clientY+this._vkTranslateYOffset,pageX:n.pageX,pageY:n.pageY+this._vkTranslateYOffset,movementX:n.movementX||0,movementY:n.movementY||0,width:n.width||0,height:n.height||0,pressure:n.pressure||0,tangentialPressure:n.tangentialPressure||0,tiltX:n.tiltX||0,tiltY:n.tiltY||0,twist:n.twist||0,timeStamp:n.timeStamp},e),n.pointerType==="mouse"){let c="mousemove";r==="pointerdown"?c="mousedown":r==="pointerup"&&(c="mouseup"),this._OnMouseEvent(c,n,t),this._mousePointerLastButtons=n.buttons}}_OnPointerRawUpdate(r){this._OnPointerEvent("pointermove",r)}_OnTouchEvent(r,n){if(!this._isExportToVideo)for(let l=0,c=n.changedTouches.length;l<c;++l){const _=n.changedTouches[l];this._PostToRuntimeMaybeSync(r,{pointerId:_.identifier,pointerType:"touch",button:0,buttons:0,lastButtons:0,clientX:_.clientX,clientY:_.clientY+this._vkTranslateYOffset,pageX:_.pageX,pageY:_.pageY+this._vkTranslateYOffset,movementX:n.movementX||0,movementY:n.movementY||0,width:(_.radiusX||_.webkitRadiusX||0)*2,height:(_.radiusY||_.webkitRadiusY||0)*2,pressure:_.force||_.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:_.rotationAngle||0,timeStamp:n.timeStamp},e)}}_HandlePointerDownFocus(r){window!==window.top&&window.focus(),this._IsElementCanvasOrDocument(r.target)&&document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(r){return!r||r===document||r===window||r===document.body||r.tagName.toLowerCase()==="canvas"}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",r=>this._OnDeviceOrientation(r)),window.addEventListener("deviceorientationabsolute",r=>this._OnDeviceOrientationAbsolute(r)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",r=>this._OnDeviceMotion(r)))}_OnDeviceOrientation(r){this._isExportToVideo||this.PostToRuntime("deviceorientation",{absolute:!!r.absolute,alpha:r.alpha||0,beta:r.beta||0,gamma:r.gamma||0,timeStamp:r.timeStamp,webkitCompassHeading:r.webkitCompassHeading,webkitCompassAccuracy:r.webkitCompassAccuracy},e)}_OnDeviceOrientationAbsolute(r){this._isExportToVideo||this.PostToRuntime("deviceorientationabsolute",{absolute:!!r.absolute,alpha:r.alpha||0,beta:r.beta||0,gamma:r.gamma||0,timeStamp:r.timeStamp},e)}_OnDeviceMotion(r){if(this._isExportToVideo)return;let n=null;const l=r.acceleration;l&&(n={x:l.x||0,y:l.y||0,z:l.z||0});let c=null;const _=r.accelerationIncludingGravity;_&&(c={x:_.x||0,y:_.y||0,z:_.z||0});let p=null;const y=r.rotationRate;y&&(p={alpha:y.alpha||0,beta:y.beta||0,gamma:y.gamma||0}),this.PostToRuntime("devicemotion",{acceleration:n,accelerationIncludingGravity:c,rotationRate:p,interval:r.interval,timeStamp:r.timeStamp},e)}_OnUpdateCanvasSize(r){const n=this.GetRuntimeInterface();if(n.IsExportingToVideo())return;const l=n.GetCanvas();l.style.width=r.styleWidth+"px",l.style.height=r.styleHeight+"px",l.style.marginLeft=r.marginLeft+"px",l.style.marginTop=r.marginTop+"px",document.documentElement.style.setProperty("--construct-scale",r.displayScale),this._isFirstSizeUpdate&&(l.style.display="",this._isFirstSizeUpdate=!1)}_OnInvokeDownload(r){const n=r.url,l=r.filename,c=document.createElement("a"),_=document.body;c.textContent=l,c.href=n,c.download=l,_.appendChild(c),c.click(),_.removeChild(c)}async _OnLoadWebFonts(r){const n=r.webfonts;await Promise.all(n.map(async l=>{const c=new FontFace(l.name,`url('${l.url}')`);document.fonts.add(c),await c.load()}))}async _OnRasterSvgImage(r){const n=r.blob,l=r.imageWidth,c=r.imageHeight,_=r.surfaceWidth,p=r.surfaceHeight,y=r.imageBitmapOpts,w=await self.C3_RasterSvgImageBlob(n,l,c,_,p);let f;return y?f=await createImageBitmap(w,y):f=await createImageBitmap(w),{imageBitmap:f,transferables:[f]}}async _OnGetSvgImageSize(r){return await self.C3_GetSvgImageSize(r.blob)}async _OnAddStylesheet(r){await o(r.url)}_PlayPendingMedia(){const r=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const n of r){const l=n.play();l&&l.catch(c=>{this._mediaRemovedPendingPlay.has(n)||this._mediaPendingPlay.add(n)})}}TryPlayMedia(r){if(typeof r.play!="function")throw new Error("missing play function");this._mediaRemovedPendingPlay.delete(r);let n;try{n=r.play()}catch{this._mediaPendingPlay.add(r);return}n&&n.catch(l=>{this._mediaRemovedPendingPlay.has(r)||this._mediaPendingPlay.add(r)})}RemovePendingPlay(r){this._mediaPendingPlay.delete(r),this._mediaRemovedPendingPlay.add(r)}SetSilent(r){this._isSilent=!!r}_OnHideCordovaSplash(){navigator.splashscreen&&navigator.splashscreen.hide&&navigator.splashscreen.hide()}_OnDebugHighlight(r){if(!r.show){this._debugHighlightElem&&(this._debugHighlightElem.style.display="none");return}this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));const l=this._debugHighlightElem;l.style.display="",l.style.left=r.left-1+"px",l.style.top=r.top-1+"px",l.style.width=r.width+2+"px",l.style.height=r.height+2+"px",l.textContent=r.name}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(r){window.c3_postToMessagePort&&(r.from="runtime",window.c3_postToMessagePort(r))}_InvokeFunctionFromJS(r,n){return this.PostToRuntimeAsync("js-invoke-function",{name:r,params:n})}_OnScriptCreateWorker(r){const n=r.url,l=r.opts,c=r.port2;new Worker(n,l).postMessage({type:"construct-worker-init",port2:c},[c])}_OnAlert(r){alert(r.message)}_OnScreenReaderTextEvent(r){const n=r.type;if(n==="create"){const l=document.createElement("p");l.id="c3-sr-"+r.id,l.textContent=r.text,this._screenReaderTextWrap.appendChild(l)}else if(n==="update"){const l=document.getElementById("c3-sr-"+r.id);l?l.textContent=r.text:console.warn(`[Construct] Missing screen reader text with id ${r.id}`)}else if(n==="release"){const l=document.getElementById("c3-sr-"+r.id);l?l.remove():console.warn(`[Construct] Missing screen reader text with id ${r.id}`)}else console.warn(`[Construct] Unknown screen reader text update '${n}'`)}_SetExportingToVideo(r){this._isExportToVideo=!0;const n=document.createElement("h1");n.id="exportToVideoMessage",n.textContent=r.message,document.body.prepend(n),document.body.classList.add("exportingToVideo"),this.GetRuntimeInterface().GetCanvas().style.display="",this._iRuntime.SetIsExportingToVideo(r.duration)}_OnExportVideoProgress(r){this._exportVideoProgressMessage=r.message,this._exportVideoUpdateTimerId===-1&&(this._exportVideoUpdateTimerId=setTimeout(()=>this._DoUpdateExportVideoProgressMessage(),250))}_DoUpdateExportVideoProgressMessage(){this._exportVideoUpdateTimerId=-1;const r=document.getElementById("exportToVideoMessage");r&&(r.textContent=this._exportVideoProgressMessage)}_OnExportedToVideo(r){window.c3_postToMessagePort({type:"exported-video",arrayBuffer:r.arrayBuffer,contentType:r.contentType,time:r.time})}_OnExportedToImageSequence(r){window.c3_postToMessagePort({type:"exported-image-sequence",blobArr:r.blobArr,time:r.time,gif:r.gif})}};d.AddDOMHandlerClass(U)}{const d="dispatchworker.js",a="jobworker.js";self.JobSchedulerDOM=class{constructor(e){this._runtimeInterface=e,this._baseUrl=e.GetRuntimeBaseURL(),e.GetExportType()==="preview"?this._baseUrl+="workers/":this._baseUrl+=e.GetScriptFolder(),this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._inputPort=null,this._outputPort=null}_GetWorkerScriptFolder(){return this._runtimeInterface.GetExportType()==="playable-ad"?this._runtimeInterface.GetScriptFolder():""}async Init(){if(this._hasInitialised)throw new Error("already initialised");this._hasInitialised=!0;const e=this._runtimeInterface._GetWorkerURL(this._GetWorkerScriptFolder()+d);this._dispatchWorker=await this._runtimeInterface.CreateWorker(e,this._baseUrl,{name:"DispatchWorker"});const t=new MessageChannel;this._inputPort=t.port1,this._dispatchWorker.postMessage({type:"_init","in-port":t.port2},[t.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const e=this._jobWorkers.length,t=this._runtimeInterface._GetWorkerURL(this._GetWorkerScriptFolder()+a),s=await this._runtimeInterface.CreateWorker(t,this._baseUrl,{name:"JobWorker"+e}),o=new MessageChannel,u=new MessageChannel;return this._dispatchWorker.postMessage({type:"_addJobWorker",port:o.port1},[o.port1]),s.postMessage({type:"init",number:e,"dispatch-port":o.port2,"output-port":u.port2},[o.port2,u.port2]),this._jobWorkers.push(s),u.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}}}window.C3_IsSupported&&(window.c3_runtimeInterface=new self.RuntimeInterface({useWorker:!1,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],projectScripts:[["scripts/project/FrameRateLimit.js"],["scripts/project/scriptsInEvents.js"]],mainProjectScript:"scripts/project/FrameRateLimit.js",scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"}));{const d=180/Math.PI,a="audio";self.AudioDOMHandler=class extends self.DOMHandler{constructor(e){super(e,a),this._audioContext=null,this._destinationNode=null,this._hasUnblocked=!1,this._hasAttachedUnblockEvents=!1,this._unblockFunc=()=>this._UnblockAudioContext(),this._audioBuffers=[],this._audioInstances=[],this._lastAudioInstance=null,this._lastPlayedTags=[],this._loadedAudioUrls=new Set,this._lastTickCount=-1,this._pendingTags=new Map,this._masterVolume=1,this._isSilent=!1,this._timeScaleMode=0,this._timeScale=1,this._gameTime=0,this._panningModel="HRTF",this._distanceModel="inverse",this._refDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._lastListenerPos=[0,0,0],this._lastListenerOrientation=[0,0,-1,0,1,0],this._playMusicAsSound=!1,this._hasAnySoftwareDecodedMusic=!1,this._supportsWebMOpus=this._iRuntime.IsAudioFormatSupported("audio/webm; codecs=opus"),this._effects=new Map,this._analysers=new Set,this._isPendingPostFxState=!1,this._hasStartedOfflineRender=!1,this._microphoneTag="",this._microphoneSource=null,self.C3Audio_OnMicrophoneStream=(t,s)=>this._OnMicrophoneStream(t,s),this._destMediaStreamNode=null,self.C3Audio_GetOutputStream=()=>this._OnGetOutputStream(),self.C3Audio_DOMInterface=this,this.AddRuntimeMessageHandlers([["create-audio-context",t=>this._CreateAudioContext(t)],["play",t=>this._Play(t)],["stop",t=>this._Stop(t)],["stop-all",()=>this._StopAll()],["set-paused",t=>this._SetPaused(t)],["set-volume",t=>this._SetVolume(t)],["fade-volume",t=>this._FadeVolume(t)],["set-master-volume",t=>this._SetMasterVolume(t)],["set-muted",t=>this._SetMuted(t)],["set-silent",t=>this._SetSilent(t)],["set-looping",t=>this._SetLooping(t)],["set-playback-rate",t=>this._SetPlaybackRate(t)],["set-stereo-pan",t=>this._SetStereoPan(t)],["seek",t=>this._Seek(t)],["preload",t=>this._Preload(t)],["unload",t=>this._Unload(t)],["unload-all",()=>this._UnloadAll()],["set-suspended",t=>this._SetSuspended(t)],["add-effect",t=>this._AddEffect(t)],["set-effect-param",t=>this._SetEffectParam(t)],["remove-effects",t=>this._RemoveEffects(t)],["tick",t=>this._OnTick(t)],["load-state",t=>this._OnLoadState(t)],["offline-render-audio",t=>this._OnOfflineRenderAudio(t)],["offline-render-finish",()=>this._OnOfflineRenderFinish()]])}async _CreateAudioContext(e){if((e.isiOSCordova||e.isSafari)&&(this._playMusicAsSound=!0),this._timeScaleMode=e.timeScaleMode,this._panningModel=["equalpower","HRTF","soundfield"][e.panningModel],this._distanceModel=["linear","inverse","exponential"][e.distanceModel],this._refDistance=e.refDistance,this._maxDistance=e.maxDistance,this._rolloffFactor=e.rolloffFactor,this._iRuntime.IsExportingToVideo()){this._playMusicAsSound=!0;const s=48e3;this._audioContext=new OfflineAudioContext({numberOfChannels:2,sampleRate:s,length:Math.ceil(this._iRuntime.GetExportToVideoDuration()*s)})}else{const s={latencyHint:e.latencyHint};if(this.SupportsWebMOpus()||(s.sampleRate=48e3),typeof AudioContext<"u")this._audioContext=new AudioContext(s);else if(typeof webkitAudioContext<"u")this._audioContext=new webkitAudioContext(s);else throw new Error("Web Audio API not supported");this._AttachUnblockEvents(),this._audioContext.onstatechange=()=>{this._audioContext.state!=="running"&&this._AttachUnblockEvents(),this.PostToRuntime("audiocontext-state",{audioContextState:this._audioContext.state})}}this._destinationNode=this._audioContext.createGain(),this._destinationNode.connect(this._audioContext.destination);const t=e.listenerPos;this._lastListenerPos[0]=t[0],this._lastListenerPos[1]=t[1],this._lastListenerPos[2]=t[2],this._audioContext.listener.setPosition(t[0],t[1],t[2]),this._audioContext.listener.setOrientation(...this._lastListenerOrientation),self.C3_GetAudioContextCurrentTime=()=>this.GetAudioCurrentTime();try{await Promise.all(e.preloadList.map(s=>this._GetAudioBuffer(s.originalUrl,s.url,s.type,!1)))}catch(s){console.error("[Construct] Preloading sounds failed: ",s)}return{sampleRate:this._audioContext.sampleRate,audioContextState:this._audioContext.state,outputLatency:this._audioContext.outputLatency||0}}_AttachUnblockEvents(){this._hasAttachedUnblockEvents||(this._hasUnblocked=!1,window.addEventListener("pointerup",this._unblockFunc,!0),window.addEventListener("touchend",this._unblockFunc,!0),window.addEventListener("click",this._unblockFunc,!0),window.addEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!0)}_DetachUnblockEvents(){this._hasAttachedUnblockEvents&&(this._hasUnblocked=!0,window.removeEventListener("pointerup",this._unblockFunc,!0),window.removeEventListener("touchend",this._unblockFunc,!0),window.removeEventListener("click",this._unblockFunc,!0),window.removeEventListener("keydown",this._unblockFunc,!0),this._hasAttachedUnblockEvents=!1)}_UnblockAudioContext(){if(this._hasUnblocked)return;const e=this._audioContext;e.state==="suspended"&&e.resume&&e.resume();const t=e.createBuffer(1,220,22050),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start(0),e.state==="running"&&this._DetachUnblockEvents()}_MatchTagLists(e,t){for(const s of t){let o=!1;for(const u of e)if(self.AudioDOMHandler.EqualsNoCase(u,s)){o=!0;break}if(!o)return!1}return!0}GetAudioContext(){return this._audioContext}GetAudioCurrentTime(){return this._audioContext.currentTime}GetDestinationNode(){return this._destinationNode}GetAudioContextExtern(){return this.GetAudioContext()}GetDestinationNodeExtern(){return this.GetDestinationNode()}GetDestinationForTag(e){const t=this._effects.get(e.toLowerCase());return t?t[0].GetInputNode():this.GetDestinationNode()}AddEffectForTag(e,t){e=e.toLowerCase();let s=this._effects.get(e);s||(s=[],this._effects.set(e,s)),t._SetIndex(s.length),t._SetTag(e),s.push(t),this._ReconnectEffects(e)}_ReconnectEffects(e){e=e.toLowerCase();let t=this.GetDestinationNode();const s=this._effects.get(e);if(s&&s.length){t=s[0].GetInputNode();for(let o=0,u=s.length;o<u;++o){const h=s[o];o+1===u?h.ConnectTo(this.GetDestinationNode()):h.ConnectTo(s[o+1].GetInputNode())}}for(const o of this.audioInstancesByEffectTag(e))o.Reconnect(t);this._microphoneSource&&this._microphoneTag===e&&(this._microphoneSource.disconnect(),this._microphoneSource.connect(t))}GetMasterVolume(){return this._masterVolume}IsSilent(){return this._isSilent}GetTimeScaleMode(){return this._timeScaleMode}GetTimeScale(){return this._timeScale}GetGameTime(){return this._gameTime}IsPlayMusicAsSound(){return this._playMusicAsSound}SupportsWebMOpus(){return this._supportsWebMOpus}_SetHasAnySoftwareDecodedMusic(){this._hasAnySoftwareDecodedMusic=!0}GetPanningModel(){return this._panningModel}GetDistanceModel(){return this._distanceModel}GetReferenceDistance(){return this._refDistance}GetMaxDistance(){return this._maxDistance}GetRolloffFactor(){return this._rolloffFactor}DecodeAudioData(e,t){return t?this._iRuntime._WasmDecodeWebMOpus(e).then(s=>{const o=this._audioContext.createBuffer(1,s.length,48e3);return o.getChannelData(0).set(s),o}):new Promise((s,o)=>{this._audioContext.decodeAudioData(e,s,o)})}TryPlayMedia(e){this._iRuntime.TryPlayMedia(e)}RemovePendingPlay(e){this._iRuntime.RemovePendingPlay(e)}ReleaseInstancesForBuffer(e){let t=0;for(let s=0,o=this._audioInstances.length;s<o;++s){const u=this._audioInstances[s];this._audioInstances[t]=u,u.GetBuffer()===e?u.Release():++t}this._audioInstances.length=t}ReleaseAllMusicBuffers(){let e=0;for(let t=0,s=this._audioBuffers.length;t<s;++t){const o=this._audioBuffers[t];this._audioBuffers[e]=o,o.IsMusic()?o.Release():++e}this._audioBuffers.length=e}*audioInstancesMatchingTags(e){if(e.length>0)for(const t of this._audioInstances)this._MatchTagLists(t.GetTags(),e)&&(yield t);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}*audioInstancesByEffectTag(e){if(e)for(const t of this._audioInstances)self.AudioDOMHandler.EqualsNoCase(t.GetEffectTag(),e)&&(yield t);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}async _GetAudioBuffer(e,t,s,o,u){for(const m of this._audioBuffers)if(m.GetUrl()===t)return await m.Load(),m;if(u)return null;o&&(this._playMusicAsSound||this._hasAnySoftwareDecodedMusic)&&this.ReleaseAllMusicBuffers();const h=self.C3AudioBuffer.Create(this,e,t,s,o);return this._audioBuffers.push(h),await h.Load(),this._loadedAudioUrls.has(e)||(this.PostToRuntime("buffer-metadata",{originalUrl:e,duration:h.GetDuration()}),this._loadedAudioUrls.add(e)),h}async _GetAudioInstance(e,t,s,o,u){for(const v of this._audioInstances)if(v.GetUrl()===t&&(v.CanBeRecycled()||u))return v.SetTags(o),v;const m=(await this._GetAudioBuffer(e,t,s,u)).CreateInstance(o);return this._audioInstances.push(m),m}_AddPendingTags(e){const t=e.join(" ");let s=this._pendingTags.get(t);if(!s){let o=null;s={pendingCount:0,promise:new Promise(h=>o=h),resolve:o},this._pendingTags.set(t,s)}s.pendingCount++}_RemovePendingTags(e){const t=e.join(" "),s=this._pendingTags.get(t);if(!s)throw new Error("expected pending tag");s.pendingCount--,s.pendingCount===0&&(s.resolve(),this._pendingTags.delete(t))}TagsReady(e){const t=(e.length===0?this._lastPlayedTags:e).join(" "),s=this._pendingTags.get(t);return s?s.promise:Promise.resolve()}_MaybeStartTicking(){if(this._analysers.size>0){this._StartTicking();return}for(const e of this._audioInstances)if(e.IsActive()){this._StartTicking();return}}Tick(){for(const s of this._analysers)s.Tick();const e=this.GetAudioCurrentTime();for(const s of this._audioInstances)s.Tick(e);const t=this._audioInstances.filter(s=>s.IsActive()).map(s=>s.GetState());this.PostToRuntime("state",{tickCount:this._lastTickCount,outputLatency:this._audioContext.outputLatency||0,audioInstances:t,analysers:[...this._analysers].map(s=>s.GetData())}),t.length===0&&this._analysers.size===0&&this._StopTicking()}PostTrigger(e,t,s){this.PostToRuntime("trigger",{type:e,tags:t,aiid:s})}async _Play(e){const t=e.originalUrl,s=e.url,o=e.type,u=e.isMusic,h=e.tags,m=e.isLooping,v=e.vol,S=e.pos,R=e.panning,A=e.stereoPan;let k=e.off;if(k>0&&!e.trueClock)if(this._audioContext.getOutputTimestamp){const P=this._audioContext.getOutputTimestamp();k=k-P.performanceTime/1e3+P.contextTime}else k=k-performance.now()/1e3+this._audioContext.currentTime;this._lastPlayedTags=h.slice(0),this._AddPendingTags(h);try{this._lastAudioInstance=await this._GetAudioInstance(t,s,o,h,u),R?(this._lastAudioInstance.SetPannerEnabled(!0),this._lastAudioInstance.SetPan(R.x,R.y,R.z,R.angle,R.innerAngle,R.outerAngle,R.outerGain),R.hasOwnProperty("uid")&&this._lastAudioInstance.SetUID(R.uid)):typeof A=="number"&&A!==0?(this._lastAudioInstance.SetStereoPannerEnabled(!0),this._lastAudioInstance.SetStereoPan(A)):(this._lastAudioInstance.SetPannerEnabled(!1),this._lastAudioInstance.SetStereoPannerEnabled(!1)),this._lastAudioInstance.Play(m,v,S,k)}catch(P){console.error("[Construct] Audio: error starting playback: ",P);return}finally{this._RemovePendingTags(h)}this._StartTicking()}_Stop(e){const t=e.tags;for(const s of this.audioInstancesMatchingTags(t))s.Stop()}_StopAll(){for(const e of this._audioInstances)e.Stop()}_SetPaused(e){const t=e.tags,s=e.paused;for(const o of this.audioInstancesMatchingTags(t))s?o.Pause():o.Resume();this._MaybeStartTicking()}_SetVolume(e){const t=e.tags,s=e.vol;for(const o of this.audioInstancesMatchingTags(t))o.SetVolume(s)}_SetStereoPan(e){const t=e.tags,s=e.p;for(const o of this.audioInstancesMatchingTags(t))o.SetStereoPannerEnabled(!0),o.SetStereoPan(s)}async _FadeVolume(e){const t=e.tags,s=e.vol,o=e.duration,u=e.stopOnEnd;await this.TagsReady(t);for(const h of this.audioInstancesMatchingTags(t))h.FadeVolume(s,o,u);this._MaybeStartTicking()}_SetMasterVolume(e){this._masterVolume=e.vol,this._destinationNode.gain.value=this._masterVolume}_SetMuted(e){const t=e.tags,s=e.isMuted;for(const o of this.audioInstancesMatchingTags(t))o.SetMuted(s)}_SetSilent(e){this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent);for(const t of this._audioInstances)t._UpdateMuted()}_SetLooping(e){const t=e.tags,s=e.isLooping;for(const o of this.audioInstancesMatchingTags(t))o.SetLooping(s)}async _SetPlaybackRate(e){const t=e.tags,s=e.rate;await this.TagsReady(t);for(const o of this.audioInstancesMatchingTags(t))o.SetPlaybackRate(s)}async _Seek(e){const t=e.tags,s=e.pos;await this.TagsReady(t);for(const o of this.audioInstancesMatchingTags(t))o.Seek(s)}async _Preload(e){const t=e.originalUrl,s=e.url,o=e.type,u=e.isMusic;try{await this._GetAudioInstance(t,s,o,"",u)}catch(h){console.error("[Construct] Audio: error preloading: ",h)}}async _Unload(e){const t=e.url,s=e.type,o=e.isMusic,u=await this._GetAudioBuffer("",t,s,o,!0);if(!u)return;u.Release();const h=this._audioBuffers.indexOf(u);h!==-1&&this._audioBuffers.splice(h,1)}_UnloadAll(){for(const e of this._audioBuffers)e.Release();this._audioBuffers.length=0}_SetSuspended(e){const t=e.isSuspended;!t&&this._audioContext.resume&&this._audioContext.resume();for(const s of this._audioInstances)s.SetSuspended(t);t&&this._audioContext.suspend&&this._audioContext.suspend()}_OnTick(e){if(this._timeScale=e.timeScale,this._gameTime=e.gameTime,this._lastTickCount=e.tickCount,this._timeScaleMode!==0)for(const o of this._audioInstances)o._UpdatePlaybackRate();const t=e.listenerPos;t&&(this._lastListenerPos[0]!==t[0]||this._lastListenerPos[1]!==t[1]||this._lastListenerPos[2]!==t[2])&&(this._lastListenerPos[0]=t[0],this._lastListenerPos[1]=t[1],this._lastListenerPos[2]=t[2],this._audioContext.listener.setPosition(t[0],t[1],t[2]));const s=e.listenerOrientation;if(s&&(this._lastListenerOrientation[0]!==s[0]||this._lastListenerOrientation[1]!==s[1]||this._lastListenerOrientation[2]!==s[2]||this._lastListenerOrientation[3]!==s[3]||this._lastListenerOrientation[4]!==s[4]||this._lastListenerOrientation[5]!==s[5])){for(let o=0;o<6;++o)this._lastListenerOrientation[o]=s[o];this._audioContext.listener.setOrientation(...this._lastListenerOrientation)}for(const o of e.instPans){const u=o.uid;for(const h of this._audioInstances)h.GetUID()===u&&h.SetPanXYZA(o.x,o.y,o.z,o.angle)}}async _AddEffect(e){const t=e.type,s=e.tags,o=e.params;let u,h;if(t==="convolution")try{h=await this._GetAudioBuffer(e.bufferOriginalUrl,e.bufferUrl,e.bufferType,!1)}catch(m){console.log("[Construct] Audio: error loading convolution: ",m);return}for(const m of s){if(t==="filter")u=new self.C3AudioFilterFX(this,...o);else if(t==="delay")u=new self.C3AudioDelayFX(this,...o);else if(t==="convolution")u=new self.C3AudioConvolveFX(this,h.GetAudioBuffer(),...o),u._SetBufferInfo(e.bufferOriginalUrl,e.bufferUrl,e.bufferType);else if(t==="flanger")u=new self.C3AudioFlangerFX(this,...o);else if(t==="phaser")u=new self.C3AudioPhaserFX(this,...o);else if(t==="gain")u=new self.C3AudioGainFX(this,...o);else if(t==="stereopan")u=new self.C3AudioStereoPanFX(this,...o);else if(t==="tremolo")u=new self.C3AudioTremoloFX(this,...o);else if(t==="ringmod")u=new self.C3AudioRingModFX(this,...o);else if(t==="distortion")u=new self.C3AudioDistortionFX(this,...o);else if(t==="compressor")u=new self.C3AudioCompressorFX(this,...o);else if(t==="analyser")u=new self.C3AudioAnalyserFX(this,...o);else throw new Error("invalid effect type");this.AddEffectForTag(m,u)}this._PostUpdatedFxState()}_SetEffectParam(e){const t=e.tags,s=e.index,o=e.param,u=e.value,h=e.ramp,m=e.time;for(const v of t){const S=this._effects.get(v.toLowerCase());!S||s<0||s>=S.length||S[s].SetParam(o,u,h,m)}this._PostUpdatedFxState()}_RemoveEffects(e){const t=e.tags;for(const s of t){const o=s.toLowerCase(),u=this._effects.get(o);if(!u||!u.length)return;for(const h of u)h.Release();this._effects.delete(o),this._ReconnectEffects(o)}}_AddAnalyser(e){this._analysers.add(e),this._MaybeStartTicking()}_RemoveAnalyser(e){this._analysers.delete(e)}_PostUpdatedFxState(){this._isPendingPostFxState||(this._isPendingPostFxState=!0,Promise.resolve().then(()=>this._DoPostUpdatedFxState()))}_DoPostUpdatedFxState(){const e={};for(const[t,s]of this._effects)e[t]=s.map(o=>o.GetState());this.PostToRuntime("fxstate",{fxstate:e}),this._isPendingPostFxState=!1}async _OnLoadState(e){const t=e.saveLoadMode;if(t!==3){const h=[];for(const m of this._audioInstances)m.IsMusic()&&t===1||!m.IsMusic()&&t===2?h.push(m):m.Release();this._audioInstances=h}for(const h of this._effects.values())for(const m of h)m.Release();this._effects.clear(),this._timeScale=e.timeScale,this._gameTime=e.gameTime;const s=e.listenerPos;this._lastListenerPos[0]=s[0],this._lastListenerPos[1]=s[1],this._lastListenerPos[2]=s[2],this._audioContext.listener.setPosition(s[0],s[1],s[2]);const o=e.listenerOrientation;if(Array.isArray(o)){for(let h=0;h<6;++h)this._lastListenerOrientation[h]=o[h];this._audioContext.listener.setOrientation(...this._lastListenerOrientation)}this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent),this._masterVolume=e.masterVolume,this._destinationNode.gain.value=this._masterVolume;const u=[];for(const h of Object.values(e.effects))u.push(Promise.all(h.map(m=>this._AddEffect(m))));await Promise.all(u),await Promise.all(e.playing.map(h=>this._LoadAudioInstance(h,t))),this._MaybeStartTicking()}async _LoadAudioInstance(e,t){if(t===3)return;const s=e.bufferOriginalUrl,o=e.bufferUrl,u=e.bufferType,h=e.isMusic,m=e.tags,v=e.isLooping,S=e.volume,R=e.playbackTime;if(h&&t===1||!h&&t===2)return;let A=null;try{A=await this._GetAudioInstance(s,o,u,m,h)}catch(k){console.error("[Construct] Audio: error loading audio state: ",k);return}A.LoadPanState(e.pan),A.LoadStereoPanState(e.stereoPan),A.Play(v,S,R,0),e.isPlaying||A.Pause(),A._LoadAdditionalState(e)}_OnMicrophoneStream(e,t){this._microphoneSource&&this._microphoneSource.disconnect(),this._microphoneTag=t.toLowerCase(),this._microphoneSource=this._audioContext.createMediaStreamSource(e),this._microphoneSource.connect(this.GetDestinationForTag(this._microphoneTag))}_OnGetOutputStream(){return this._destMediaStreamNode||(this._destMediaStreamNode=this._audioContext.createMediaStreamDestination(),this._destinationNode.connect(this._destMediaStreamNode)),this._destMediaStreamNode.stream}async _OnOfflineRenderAudio(e){try{const t=e.time,s=this._audioContext.suspend(t);this._hasStartedOfflineRender?this._audioContext.resume():(this._audioContext.startRendering().then(o=>this._OnOfflineRenderCompleted(o)).catch(o=>this._OnOfflineRenderError(o)),this._hasStartedOfflineRender=!0),await s}catch(t){this._OnOfflineRenderError(t)}}_OnOfflineRenderFinish(){this._audioContext.resume()}_OnOfflineRenderCompleted(e){const t=[];for(let s=0,o=e.numberOfChannels;s<o;++s){const u=e.getChannelData(s);t.push(u.buffer)}this._iRuntime.PostToRuntimeComponent("runtime","offline-audio-render-completed",{duration:e.duration,length:e.length,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate,channelData:t},null,t)}_OnOfflineRenderError(e){console.error("[Audio] Offline rendering error: ",e)}static EqualsNoCase(e,t){return e===t||e.normalize().toLowerCase()===t.normalize().toLowerCase()}static ToDegrees(e){return e*d}static DbToLinearNoCap(e){return Math.pow(10,e/20)}static DbToLinear(e){return Math.max(Math.min(self.AudioDOMHandler.DbToLinearNoCap(e),1),0)}static LinearToDbNoCap(e){return Math.log(e)/Math.log(10)*20}static LinearToDb(e){return self.AudioDOMHandler.LinearToDbNoCap(Math.max(Math.min(e,1),0))}static e4(e,t){return 1-Math.exp(-t*e)}},self.RuntimeInterface.AddDOMHandlerClass(self.AudioDOMHandler)}self.C3AudioBuffer=class{constructor(a,i,e,t,s){this._audioDomHandler=a,this._originalUrl=i,this._url=e,this._type=t,this._isMusic=s,this._api="",this._loadState="not-loaded",this._loadPromise=null}Release(){this._loadState="not-loaded",this._audioDomHandler=null,this._loadPromise=null}static Create(a,i,e,t,s){const o=t==="audio/webm; codecs=opus"&&!a.SupportsWebMOpus();return s&&o&&a._SetHasAnySoftwareDecodedMusic(),!s||a.IsPlayMusicAsSound()||o?new self.C3WebAudioBuffer(a,i,e,t,s,o):new self.C3Html5AudioBuffer(a,i,e,t,s)}CreateInstance(a){return this._api==="html5"?new self.C3Html5AudioInstance(this._audioDomHandler,this,a):new self.C3WebAudioInstance(this._audioDomHandler,this,a)}_Load(){}Load(){return this._loadPromise||(this._loadPromise=this._Load()),this._loadPromise}IsLoaded(){}IsLoadedAndDecoded(){}HasFailedToLoad(){return this._loadState==="failed"}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetApi(){return this._api}GetOriginalUrl(){return this._originalUrl}GetUrl(){return this._url}GetContentType(){return this._type}IsMusic(){return this._isMusic}GetDuration(){}};self.C3Html5AudioBuffer=class extends self.C3AudioBuffer{constructor(a,i,e,t,s){super(a,i,e,t,s),this._api="html5",this._audioElem=new Audio,this._audioElem.crossOrigin="anonymous",this._audioElem.autoplay=!1,this._audioElem.preload="auto",this._loadResolve=null,this._loadReject=null,this._reachedCanPlayThrough=!1,this._audioElem.addEventListener("canplaythrough",()=>this._reachedCanPlayThrough=!0),this._outNode=this.GetAudioContext().createGain(),this._mediaSourceNode=null,this._audioElem.addEventListener("canplay",()=>{this._loadResolve&&(this._loadState="loaded",this._loadResolve(),this._loadResolve=null,this._loadReject=null),!(this._mediaSourceNode||!this._audioElem)&&(this._mediaSourceNode=this.GetAudioContext().createMediaElementSource(this._audioElem),this._mediaSourceNode.connect(this._outNode))}),this.onended=null,this._audioElem.addEventListener("ended",()=>{this.onended&&this.onended()}),this._audioElem.addEventListener("error",o=>this._OnError(o))}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._outNode.disconnect(),this._outNode=null,this._mediaSourceNode.disconnect(),this._mediaSourceNode=null,this._audioElem&&!this._audioElem.paused&&this._audioElem.pause(),this.onended=null,this._audioElem=null,super.Release()}_Load(){return this._loadState="loading",new Promise((a,i)=>{this._loadResolve=a,this._loadReject=i,this._audioElem.src=this._url})}_OnError(a){console.error(`[Construct] Audio '${this._url}' error: `,a),this._loadReject&&(this._loadState="failed",this._loadReject(a),this._loadResolve=null,this._loadReject=null)}IsLoaded(){const a=this._audioElem.readyState>=4;return a&&(this._reachedCanPlayThrough=!0),a||this._reachedCanPlayThrough}IsLoadedAndDecoded(){return this.IsLoaded()}GetAudioElement(){return this._audioElem}GetOutputNode(){return this._outNode}GetDuration(){return this._audioElem.duration}};self.C3WebAudioBuffer=class extends self.C3AudioBuffer{constructor(a,i,e,t,s,o){super(a,i,e,t,s),this._api="webaudio",this._audioData=null,this._audioBuffer=null,this._needsSoftwareDecode=!!o}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._audioData=null,this._audioBuffer=null,super.Release()}async _Fetch(){if(this._audioData)return this._audioData;const a=this._audioDomHandler.GetRuntimeInterface();if(a.GetExportType()==="cordova"&&a.IsRelativeURL(this._url)&&a.IsFileProtocol())this._audioData=await a.CordovaFetchLocalFileAsArrayBuffer(this._url);else{const i=await fetch(this._url);if(!i.ok)throw new Error(`error fetching audio data: ${i.status} ${i.statusText}`);this._audioData=await i.arrayBuffer()}}async _Decode(){if(this._audioBuffer)return this._audioBuffer;this._audioBuffer=await this._audioDomHandler.DecodeAudioData(this._audioData,this._needsSoftwareDecode),this._audioData=null}async _Load(){try{this._loadState="loading",await this._Fetch(),await this._Decode(),this._loadState="loaded"}catch(a){this._loadState="failed",console.error(`[Construct] Failed to load audio '${this._url}': `,a)}}IsLoaded(){return!!(this._audioData||this._audioBuffer)}IsLoadedAndDecoded(){return!!this._audioBuffer}GetAudioBuffer(){return this._audioBuffer}GetDuration(){return this._audioBuffer?this._audioBuffer.duration:0}};{let d=0;self.C3AudioInstance=class{constructor(i,e,t){this._audioDomHandler=i,this._buffer=e,this._tags=t,this._aiId=d++,this._gainNode=this.GetAudioContext().createGain(),this._gainNode.connect(this.GetDestinationNode()),this._pannerNode=null,this._isPannerEnabled=!1,this._pannerPosition=[0,0,0],this._pannerOrientation=[0,0,0],this._pannerConeParams=[0,0,0],this._stereoPannerNode=null,this._isStereoPannerEnabled=!1,this._stereoPan=0,this._isStopped=!0,this._isPaused=!1,this._resumeMe=!1,this._isLooping=!1,this._volume=1,this._isMuted=!1,this._playbackRate=1;const s=this._audioDomHandler.GetTimeScaleMode();this._isTimescaled=s===1&&!this.IsMusic()||s===2,this._instUid=-1,this._fadeEndTime=-1,this._stopOnFadeEnd=!1}Release(){this._audioDomHandler=null,this._buffer=null,this._pannerNode&&(this._pannerNode.disconnect(),this._pannerNode=null),this._stereoPannerNode&&(this._stereoPannerNode.disconnect(),this._stereoPannerNode=null),this._gainNode.disconnect(),this._gainNode=null}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}SetTags(i){this._tags=i}GetTags(){return this._tags}GetEffectTag(){return this._tags.length>0?this._tags[0]:""}GetDestinationNode(){return this._audioDomHandler.GetDestinationForTag(this.GetEffectTag())}GetCurrentTime(){return this._isTimescaled?this._audioDomHandler.GetGameTime():performance.now()/1e3}GetOriginalUrl(){return this._buffer.GetOriginalUrl()}GetUrl(){return this._buffer.GetUrl()}GetContentType(){return this._buffer.GetContentType()}GetBuffer(){return this._buffer}IsMusic(){return this._buffer.IsMusic()}GetAiId(){return this._aiId}HasEnded(){}CanBeRecycled(){}IsPlaying(){return!this._isStopped&&!this._isPaused&&!this.HasEnded()}IsActive(){return!this._isStopped&&!this.HasEnded()}GetPlaybackTime(){}GetDuration(i){let e=this._buffer.GetDuration();return i&&(e/=this._playbackRate||.001),e}Play(i,e,t,s){}Stop(){}Pause(){}IsPaused(){return this._isPaused}Resume(){}SetVolume(i){this._volume=i,this._gainNode.gain.cancelScheduledValues(0),this._fadeEndTime=-1,this._gainNode.gain.value=this.GetOutputVolume()}FadeVolume(i,e,t){if(this.IsMuted())return;const s=this._gainNode.gain;s.cancelScheduledValues(0);const o=this._audioDomHandler.GetAudioCurrentTime(),u=o+e;s.setValueAtTime(s.value,o),s.linearRampToValueAtTime(i,u),this._volume=i,this._fadeEndTime=u,this._stopOnFadeEnd=t}_UpdateVolume(){this.SetVolume(this._volume)}Tick(i){this._fadeEndTime!==-1&&i>=this._fadeEndTime&&(this._fadeEndTime=-1,this._stopOnFadeEnd&&this.Stop(),this._audioDomHandler.PostTrigger("fade-ended",this._tags,this._aiId))}GetOutputVolume(){const i=this._volume;return isFinite(i)?i:0}SetMuted(i){i=!!i,this._isMuted!==i&&(this._isMuted=i,this._UpdateMuted())}IsMuted(){return this._isMuted}IsSilent(){return this._audioDomHandler.IsSilent()}_UpdateMuted(){}SetLooping(i){}IsLooping(){return this._isLooping}SetPlaybackRate(i){this._playbackRate!==i&&(this._playbackRate=i,this._UpdatePlaybackRate())}_UpdatePlaybackRate(){}GetPlaybackRate(){return this._playbackRate}Seek(i){}SetSuspended(i){}SetPannerEnabled(i){i=!!i,this._isPannerEnabled!==i&&(this._isPannerEnabled=i,this._isPannerEnabled?(this.SetStereoPannerEnabled(!1),this._pannerNode||(this._pannerNode=this.GetAudioContext().createPanner(),this._pannerNode.panningModel=this._audioDomHandler.GetPanningModel(),this._pannerNode.distanceModel=this._audioDomHandler.GetDistanceModel(),this._pannerNode.refDistance=this._audioDomHandler.GetReferenceDistance(),this._pannerNode.maxDistance=this._audioDomHandler.GetMaxDistance(),this._pannerNode.rolloffFactor=this._audioDomHandler.GetRolloffFactor()),this._gainNode.disconnect(),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(this.GetDestinationNode())):(this._pannerNode.disconnect(),this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetPan(i,e,t,s,o,u,h){if(!this._isPannerEnabled)return;this.SetPanXYZA(i,e,t,s);const m=self.AudioDOMHandler.ToDegrees;this._pannerConeParams[0]!==m(o)&&(this._pannerConeParams[0]=m(o),this._pannerNode.coneInnerAngle=m(o)),this._pannerConeParams[1]!==m(u)&&(this._pannerConeParams[1]=m(u),this._pannerNode.coneOuterAngle=m(u)),this._pannerConeParams[2]!==h&&(this._pannerConeParams[2]=h,this._pannerNode.coneOuterGain=h)}SetPanXYZA(i,e,t,s){if(!this._isPannerEnabled)return;const o=this._pannerPosition,u=this._pannerOrientation,h=Math.cos(s),m=Math.sin(s);(o[0]!==i||o[1]!==e||o[2]!==t)&&(o[0]=i,o[1]=e,o[2]=t,this._pannerNode.setPosition(...o)),(u[0]!==h||u[1]!==m||u[2]!==0)&&(u[0]=h,u[1]=m,u[2]=0,this._pannerNode.setOrientation(...u))}SetStereoPannerEnabled(i){i=!!i,this._isStereoPannerEnabled!==i&&(this._isStereoPannerEnabled=i,this._isStereoPannerEnabled?(this.SetPannerEnabled(!1),this._stereoPannerNode=this.GetAudioContext().createStereoPanner(),this._gainNode.disconnect(),this._gainNode.connect(this._stereoPannerNode),this._stereoPannerNode.connect(this.GetDestinationNode())):(this._stereoPannerNode.disconnect(),this._stereoPannerNode=null,this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetStereoPan(i){this._isStereoPannerEnabled&&this._stereoPan!==i&&(this._stereoPannerNode.pan.value=i,this._stereoPan=i)}SetUID(i){this._instUid=i}GetUID(){return this._instUid}GetResumePosition(){}Reconnect(i){const e=this._stereoPannerNode||this._pannerNode||this._gainNode;e.disconnect(),e.connect(i)}GetState(){return{aiid:this.GetAiId(),tags:this._tags,duration:this.GetDuration(),volume:this._fadeEndTime===-1?this._volume:this._gainNode.gain.value,isPlaying:this.IsPlaying(),playbackTime:this.GetPlaybackTime(),playbackRate:this.GetPlaybackRate(),uid:this._instUid,bufferOriginalUrl:this.GetOriginalUrl(),bufferUrl:"",bufferType:this.GetContentType(),isMusic:this.IsMusic(),isLooping:this.IsLooping(),isMuted:this.IsMuted(),resumePosition:this.GetResumePosition(),pan:this.GetPanState(),stereoPan:this.GetStereoPanState()}}_LoadAdditionalState(i){this.SetPlaybackRate(i.playbackRate),this.SetMuted(i.isMuted)}GetPanState(){if(!this._pannerNode)return null;const i=this._pannerNode;return{pos:this._pannerPosition,orient:this._pannerOrientation,cia:i.coneInnerAngle,coa:i.coneOuterAngle,cog:i.coneOuterGain,uid:this._instUid}}LoadPanState(i){if(!i){this.SetPannerEnabled(!1);return}this.SetPannerEnabled(!0);const e=this._pannerNode,t=i.pos;this._pannerPosition[0]=t[0],this._pannerPosition[1]=t[1],this._pannerPosition[2]=t[2];const s=i.orient;this._pannerOrientation[0]=s[0],this._pannerOrientation[1]=s[1],this._pannerOrientation[2]=s[2],e.setPosition(...this._pannerPosition),e.setOrientation(...this._pannerOrientation),this._pannerConeParams[0]=i.cia,this._pannerConeParams[1]=i.coa,this._pannerConeParams[2]=i.cog,e.coneInnerAngle=i.cia,e.coneOuterAngle=i.coa,e.coneOuterGain=i.cog,this._instUid=i.uid}GetStereoPanState(){return this._stereoPannerNode?this._stereoPan:null}LoadStereoPanState(i){if(typeof i!="number"){this.SetStereoPannerEnabled(!1);return}this.SetStereoPannerEnabled(!0),this.SetStereoPan(i)}}}self.C3Html5AudioInstance=class extends self.C3AudioInstance{constructor(a,i,e){super(a,i,e),this._buffer.GetOutputNode().connect(this._gainNode),this._buffer.onended=()=>this._OnEnded()}Release(){this.Stop(),this._buffer.GetOutputNode().disconnect(),super.Release()}GetAudioElement(){return this._buffer.GetAudioElement()}_OnEnded(){this._isStopped=!0,this._instUid=-1,this._audioDomHandler.PostTrigger("ended",this._tags,this._aiId)}HasEnded(){return this.GetAudioElement().ended}CanBeRecycled(){return this._isStopped?!0:this.HasEnded()}GetPlaybackTime(){let a=this.GetAudioElement().currentTime;return this._isLooping||(a=Math.min(a,this.GetDuration())),a}Play(a,i,e,t){const s=this.GetAudioElement();if(s.playbackRate!==1&&(s.playbackRate=1),s.loop!==a&&(s.loop=a),this.SetVolume(i),s.muted&&(s.muted=!1),s.currentTime!==e)try{s.currentTime=e}catch(o){console.warn(`[Construct] Exception seeking audio '${this._buffer.GetUrl()}' to position '${e}': `,o)}this._audioDomHandler.TryPlayMedia(s),this._isStopped=!1,this._isPaused=!1,this._isLooping=a,this._playbackRate=1}Stop(){const a=this.GetAudioElement();a.paused||a.pause(),this._audioDomHandler.RemovePendingPlay(a),this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){if(this._isPaused||this._isStopped||this.HasEnded())return;const a=this.GetAudioElement();a.paused||a.pause(),this._audioDomHandler.RemovePendingPlay(a),this._isPaused=!0}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._isPaused=!1)}_UpdateMuted(){this.GetAudioElement().muted=this._isMuted||this.IsSilent()}SetLooping(a){a=!!a,this._isLooping!==a&&(this._isLooping=a,this.GetAudioElement().loop=a)}_UpdatePlaybackRate(){let a=this._playbackRate;this._isTimescaled&&(a*=this._audioDomHandler.GetTimeScale());try{this.GetAudioElement().playbackRate=a}catch(i){console.warn(`[Construct] Unable to set playback rate '${a}':`,i)}}Seek(a){if(!(this._isStopped||this.HasEnded()))try{this.GetAudioElement().currentTime=a}catch(i){console.warn(`[Construct] Error seeking audio to '${a}': `,i)}}GetResumePosition(){return this.GetPlaybackTime()}SetSuspended(a){a?this.IsPlaying()?(this.GetAudioElement().pause(),this._resumeMe=!0):this._resumeMe=!1:this._resumeMe&&(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._resumeMe=!1)}};self.C3WebAudioInstance=class extends self.C3AudioInstance{constructor(a,i,e){super(a,i,e),this._bufferSource=null,this._onended_handler=t=>this._OnEnded(t),this._hasPlaybackEnded=!0,this._activeSource=null,this._playStartTime=0,this._playFromSeekPos=0,this._resumePosition=0,this._muteVol=1}Release(){this.Stop(),this._ReleaseBufferSource(),this._onended_handler=null,super.Release()}_ReleaseBufferSource(){this._bufferSource&&(this._bufferSource.onended=null,this._bufferSource.disconnect(),this._bufferSource.buffer=null),this._bufferSource=null,this._activeSource=null}_OnEnded(a){this._isPaused||this._resumeMe||a.target===this._activeSource&&(this._hasPlaybackEnded=!0,this._isStopped=!0,this._instUid=-1,this._ReleaseBufferSource(),this._audioDomHandler.PostTrigger("ended",this._tags,this._aiId))}HasEnded(){return!this._isStopped&&this._bufferSource&&this._bufferSource.loop||this._isPaused?!1:this._hasPlaybackEnded}CanBeRecycled(){return!this._bufferSource||this._isStopped?!0:this.HasEnded()}GetPlaybackTime(){let a=0;return this._isPaused?a=this._resumePosition:a=this._playFromSeekPos+(this.GetCurrentTime()-this._playStartTime)*this._playbackRate,this._isLooping||(a=Math.min(a,this.GetDuration())),a}Play(a,i,e,t){this._muteVol=1,this.SetVolume(i),this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=a,this._bufferSource.start(t,e),this._hasPlaybackEnded=!1,this._isStopped=!1,this._isPaused=!1,this._isLooping=a,this._playbackRate=1,this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=e}Stop(){if(this._bufferSource)try{this._bufferSource.stop(0)}catch{}this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){this._isPaused||this._isStopped||this.HasEnded()||(this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._isPaused=!0,this._bufferSource.stop(0))}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._isPaused=!1)}GetOutputVolume(){return super.GetOutputVolume()*this._muteVol}_UpdateMuted(){this._muteVol=this._isMuted||this.IsSilent()?0:1,this._UpdateVolume()}SetLooping(a){a=!!a,this._isLooping!==a&&(this._isLooping=a,this._bufferSource&&(this._bufferSource.loop=a))}_UpdatePlaybackRate(){let a=this._playbackRate;this._isTimescaled&&(a*=this._audioDomHandler.GetTimeScale()),this._bufferSource&&(this._bufferSource.playbackRate.value=a)}Seek(a){this._isStopped||this.HasEnded()||(this._isPaused?this._resumePosition=a:(this.Pause(),this._resumePosition=a,this.Resume()))}GetResumePosition(){return this._resumePosition}SetSuspended(a){a?this.IsPlaying()?(this._resumeMe=!0,this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._bufferSource.stop(0)):this._resumeMe=!1:this._resumeMe&&(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._resumeMe=!1)}_LoadAdditionalState(a){super._LoadAdditionalState(a),this._resumePosition=a.resumePosition}};{class d{constructor(i){this._audioDomHandler=i,this._audioContext=i.GetAudioContext(),this._index=-1,this._tag="",this._type="",this._params=null}Release(){this._audioContext=null}_SetIndex(i){this._index=i}GetIndex(){return this._index}_SetTag(i){this._tag=i}GetTag(){return this._tag}CreateGain(){return this._audioContext.createGain()}GetInputNode(){}ConnectTo(i){}SetAudioParam(i,e,t,s){if(i.cancelScheduledValues(0),s===0){i.value=e;return}const o=this._audioContext.currentTime;switch(s+=o,t){case 0:i.setValueAtTime(e,s);break;case 1:i.setValueAtTime(i.value,o),i.linearRampToValueAtTime(e,s);break;case 2:i.setValueAtTime(i.value,o),i.exponentialRampToValueAtTime(e,s);break}}GetState(){return{type:this._type,tag:this._tag,params:this._params}}}self.C3AudioFilterFX=class extends d{constructor(i,e,t,s,o,u,h){super(i),this._type="filter",this._params=[e,t,s,o,u,h],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=h,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-h,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type=e,this._filterNode.frequency.value=t,this._filterNode.detune.value=s,this._filterNode.Q.value=o,this._filterNode.gain.vlaue=u,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._filterNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(i){this._wetNode.disconnect(),this._wetNode.connect(i),this._dryNode.disconnect(),this._dryNode.connect(i)}GetInputNode(){return this._inputNode}SetParam(i,e,t,s){switch(i){case 0:e=Math.max(Math.min(e/100,1),0),this._params[5]=e,this.SetAudioParam(this._wetNode.gain,e,t,s),this.SetAudioParam(this._dryNode.gain,1-e,t,s);break;case 1:this._params[1]=e,this.SetAudioParam(this._filterNode.frequency,e,t,s);break;case 2:this._params[2]=e,this.SetAudioParam(this._filterNode.detune,e,t,s);break;case 3:this._params[3]=e,this.SetAudioParam(this._filterNode.Q,e,t,s);break;case 4:this._params[4]=e,this.SetAudioParam(this._filterNode.gain,e,t,s);break}}},self.C3AudioDelayFX=class extends d{constructor(i,e,t,s){super(i),this._type="delay",this._params=[e,t,s],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=s,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-s,this._mainNode=this.CreateGain(),this._delayNode=this._audioContext.createDelay(e),this._delayNode.delayTime.value=e,this._delayGainNode=this.CreateGain(),this._delayGainNode.gain.value=t,this._inputNode.connect(this._mainNode),this._inputNode.connect(this._dryNode),this._mainNode.connect(this._wetNode),this._mainNode.connect(this._delayNode),this._delayNode.connect(this._delayGainNode),this._delayGainNode.connect(this._mainNode)}Release(){this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),this._mainNode.disconnect(),this._delayNode.disconnect(),this._delayGainNode.disconnect(),super.Release()}ConnectTo(i){this._wetNode.disconnect(),this._wetNode.connect(i),this._dryNode.disconnect(),this._dryNode.connect(i)}GetInputNode(){return this._inputNode}SetParam(i,e,t,s){const o=self.AudioDOMHandler.DbToLinear;switch(i){case 0:e=Math.max(Math.min(e/100,1),0),this._params[2]=e,this.SetAudioParam(this._wetNode.gain,e,t,s),this.SetAudioParam(this._dryNode.gain,1-e,t,s);break;case 4:this._params[1]=o(e),this.SetAudioParam(this._delayGainNode.gain,o(e),t,s);break;case 5:this._params[0]=e,this.SetAudioParam(this._delayNode.delayTime,e,t,s);break}}},self.C3AudioConvolveFX=class extends d{constructor(i,e,t,s){super(i),this._type="convolution",this._params=[t,s],this._bufferOriginalUrl="",this._bufferUrl="",this._bufferType="",this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=s,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-s,this._convolveNode=this._audioContext.createConvolver(),this._convolveNode.normalize=t,this._convolveNode.buffer=e,this._inputNode.connect(this._convolveNode),this._inputNode.connect(this._dryNode),this._convolveNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._convolveNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(i){this._wetNode.disconnect(),this._wetNode.connect(i),this._dryNode.disconnect(),this._dryNode.connect(i)}GetInputNode(){return this._inputNode}SetParam(i,e,t,s){switch(i){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._wetNode.gain,e,t,s),this.SetAudioParam(this._dryNode.gain,1-e,t,s);break}}_SetBufferInfo(i,e,t){this._bufferOriginalUrl=i,this._bufferUrl=e,this._bufferType=t}GetState(){const i=super.GetState();return i.bufferOriginalUrl=this._bufferOriginalUrl,i.bufferUrl="",i.bufferType=this._bufferType,i}},self.C3AudioFlangerFX=class extends d{constructor(i,e,t,s,o,u){super(i),this._type="flanger",this._params=[e,t,s,o,u],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-u/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=u/2,this._feedbackNode=this.CreateGain(),this._feedbackNode.gain.value=o,this._delayNode=this._audioContext.createDelay(e+t),this._delayNode.delayTime.value=e,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=s,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=t,this._inputNode.connect(this._delayNode),this._inputNode.connect(this._dryNode),this._delayNode.connect(this._wetNode),this._delayNode.connect(this._feedbackNode),this._feedbackNode.connect(this._delayNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._delayNode.delayTime),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._delayNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),this._feedbackNode.disconnect(),super.Release()}ConnectTo(i){this._wetNode.disconnect(),this._wetNode.connect(i),this._dryNode.disconnect(),this._dryNode.connect(i)}GetInputNode(){return this._inputNode}SetParam(i,e,t,s){switch(i){case 0:e=Math.max(Math.min(e/100,1),0),this._params[4]=e,this.SetAudioParam(this._wetNode.gain,e/2,t,s),this.SetAudioParam(this._dryNode.gain,1-e/2,t,s);break;case 6:this._params[1]=e/1e3,this.SetAudioParam(this._oscGainNode.gain,e/1e3,t,s);break;case 7:this._params[2]=e,this.SetAudioParam(this._oscNode.frequency,e,t,s);break;case 8:this._params[3]=e/100,this.SetAudioParam(this._feedbackNode.gain,e/100,t,s);break}}},self.C3AudioPhaserFX=class extends d{constructor(i,e,t,s,o,u,h){super(i),this._type="phaser",this._params=[e,t,s,o,u,h],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-h/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=h/2,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type="allpass",this._filterNode.frequency.value=e,this._filterNode.detune.value=t,this._filterNode.Q.value=s,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=u,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=o,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._filterNode.frequency),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._filterNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),super.Release()}ConnectTo(i){this._wetNode.disconnect(),this._wetNode.connect(i),this._dryNode.disconnect(),this._dryNode.connect(i)}GetInputNode(){return this._inputNode}SetParam(i,e,t,s){switch(i){case 0:e=Math.max(Math.min(e/100,1),0),this._params[5]=e,this.SetAudioParam(this._wetNode.gain,e/2,t,s),this.SetAudioParam(this._dryNode.gain,1-e/2,t,s);break;case 1:this._params[0]=e,this.SetAudioParam(this._filterNode.frequency,e,t,s);break;case 2:this._params[1]=e,this.SetAudioParam(this._filterNode.detune,e,t,s);break;case 3:this._params[2]=e,this.SetAudioParam(this._filterNode.Q,e,t,s);break;case 6:this._params[3]=e,this.SetAudioParam(this._oscGainNode.gain,e,t,s);break;case 7:this._params[4]=e,this.SetAudioParam(this._oscNode.frequency,e,t,s);break}}},self.C3AudioGainFX=class extends d{constructor(i,e){super(i),this._type="gain",this._params=[e],this._node=this.CreateGain(),this._node.gain.value=e}Release(){this._node.disconnect(),super.Release()}ConnectTo(i){this._node.disconnect(),this._node.connect(i)}GetInputNode(){return this._node}SetParam(i,e,t,s){const o=self.AudioDOMHandler.DbToLinear;switch(i){case 4:this._params[0]=o(e),this.SetAudioParam(this._node.gain,o(e),t,s);break}}},self.C3AudioStereoPanFX=class extends d{constructor(i,e){super(i),this._type="stereopan",this._params=[e],this._node=this._audioContext.createStereoPanner(),this._node.pan.value=e}Release(){this._node.disconnect(),super.Release()}ConnectTo(i){this._node.disconnect(),this._node.connect(i)}GetInputNode(){return this._node}SetParam(i,e,t,s){switch(e=Math.min(Math.max(e/100,-1),1),i){case 9:this._params[0]=e,this.SetAudioParam(this._node.pan,e,t,s);break}}},self.C3AudioTremoloFX=class extends d{constructor(i,e,t){super(i),this._type="tremolo",this._params=[e,t],this._node=this.CreateGain(),this._node.gain.value=1-t/2,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=e,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=t/2,this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._node.gain),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._node.disconnect(),super.Release()}ConnectTo(i){this._node.disconnect(),this._node.connect(i)}GetInputNode(){return this._node}SetParam(i,e,t,s){switch(i){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._node.gain,1-e/2,t,s),this.SetAudioParam(this._oscGainNode.gain,e/2,t,s);break;case 7:this._params[0]=e,this.SetAudioParam(this._oscNode.frequency,e,t,s);break}}},self.C3AudioRingModFX=class extends d{constructor(i,e,t){super(i),this._type="ringmod",this._params=[e,t],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=t,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-t,this._ringNode=this.CreateGain(),this._ringNode.gain.value=0,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=e,this._oscNode.connect(this._ringNode.gain),this._oscNode.start(0),this._inputNode.connect(this._ringNode),this._inputNode.connect(this._dryNode),this._ringNode.connect(this._wetNode)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._ringNode.disconnect(),this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(i){this._wetNode.disconnect(),this._wetNode.connect(i),this._dryNode.disconnect(),this._dryNode.connect(i)}GetInputNode(){return this._inputNode}SetParam(i,e,t,s){switch(i){case 0:e=Math.max(Math.min(e/100,1),0),this._params[1]=e,this.SetAudioParam(this._wetNode.gain,e,t,s),this.SetAudioParam(this._dryNode.gain,1-e,t,s);break;case 7:this._params[0]=e,this.SetAudioParam(this._oscNode.frequency,e,t,s);break}}},self.C3AudioDistortionFX=class extends d{constructor(i,e,t,s,o,u){super(i),this._type="distortion",this._params=[e,t,s,o,u],this._inputNode=this.CreateGain(),this._preGain=this.CreateGain(),this._postGain=this.CreateGain(),this._SetDrive(s,o),this._wetNode=this.CreateGain(),this._wetNode.gain.value=u,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-u,this._waveShaper=this._audioContext.createWaveShaper(),this._curve=new Float32Array(65536),this._GenerateColortouchCurve(e,t),this._waveShaper.curve=this._curve,this._inputNode.connect(this._preGain),this._inputNode.connect(this._dryNode),this._preGain.connect(this._waveShaper),this._waveShaper.connect(this._postGain),this._postGain.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._preGain.disconnect(),this._waveShaper.disconnect(),this._postGain.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}_SetDrive(i,e){i<.01&&(i=.01),this._preGain.gain.value=i,this._postGain.gain.value=Math.pow(1/i,.6)*e}_GenerateColortouchCurve(i,e){for(let o=0;o<32768;++o){let u=o/32768;u=this._Shape(u,i,e),this._curve[32768+o]=u,this._curve[32768-o-1]=-u}}_Shape(i,e,t){const o=1.05*t*e-e,u=i<0?-1:1,h=i<0?-i:i;let m=h<e?h:e+o*self.AudioDOMHandler.e4(h-e,1/o);return m*=u,m}ConnectTo(i){this._wetNode.disconnect(),this._wetNode.connect(i),this._dryNode.disconnect(),this._dryNode.connect(i)}GetInputNode(){return this._inputNode}SetParam(i,e,t,s){switch(i){case 0:e=Math.max(Math.min(e/100,1),0),this._params[4]=e,this.SetAudioParam(this._wetNode.gain,e,t,s),this.SetAudioParam(this._dryNode.gain,1-e,t,s);break}}},self.C3AudioCompressorFX=class extends d{constructor(i,e,t,s,o,u){super(i),this._type="compressor",this._params=[e,t,s,o,u],this._node=this._audioContext.createDynamicsCompressor(),this._node.threshold.value=e,this._node.knee.value=t,this._node.ratio.value=s,this._node.attack.value=o,this._node.release.value=u}Release(){this._node.disconnect(),super.Release()}ConnectTo(i){this._node.disconnect(),this._node.connect(i)}GetInputNode(){return this._node}SetParam(i,e,t,s){}},self.C3AudioAnalyserFX=class extends d{constructor(i,e,t){super(i),this._type="analyser",this._params=[e,t],this._node=this._audioContext.createAnalyser(),this._node.fftSize=e,this._node.smoothingTimeConstant=t,this._freqBins=new Float32Array(this._node.frequencyBinCount),this._signal=new Uint8Array(e),this._peak=0,this._rms=0,this._audioDomHandler._AddAnalyser(this)}Release(){this._audioDomHandler._RemoveAnalyser(this),this._node.disconnect(),super.Release()}Tick(){this._node.getFloatFrequencyData(this._freqBins),this._node.getByteTimeDomainData(this._signal);const i=this._node.fftSize;this._peak=0;let e=0;for(let s=0;s<i;++s){let o=(this._signal[s]-128)/128;o<0&&(o=-o),this._peak<o&&(this._peak=o),e+=o*o}const t=self.AudioDOMHandler.LinearToDb;this._peak=t(this._peak),this._rms=t(Math.sqrt(e/i))}ConnectTo(i){this._node.disconnect(),this._node.connect(i)}GetInputNode(){return this._node}SetParam(i,e,t,s){}GetData(){return{tag:this.GetTag(),index:this.GetIndex(),peak:this._peak,rms:this._rms,binCount:this._node.frequencyBinCount,freqBins:this._freqBins}}}}{const d="mouse",a=class extends self.DOMHandler{constructor(e){super(e,d),this.AddRuntimeMessageHandlers([["cursor",t=>this._OnChangeCursorStyle(t)],["request-pointer-lock",()=>this._OnRequestPointerLock()],["release-pointer-lock",()=>this._OnReleasePointerLock()]]),document.addEventListener("pointerlockchange",t=>this._OnPointerLockChange()),document.addEventListener("pointerlockerror",t=>this._OnPointerLockError())}_OnChangeCursorStyle(e){document.documentElement.style.cursor=e}_OnRequestPointerLock(){this._iRuntime.GetCanvas().requestPointerLock()}_OnReleasePointerLock(){document.exitPointerLock()}_OnPointerLockChange(){this.PostToRuntime("pointer-lock-change",{"has-pointer-lock":!!document.pointerLockElement})}_OnPointerLockError(){this.PostToRuntime("pointer-lock-error",{"has-pointer-lock":!!document.pointerLockElement})}};self.RuntimeInterface.AddDOMHandlerClass(a)}{const d="touch",a=class extends self.DOMHandler{constructor(e){super(e,d),this.AddRuntimeMessageHandler("request-permission",t=>this._OnRequestPermission(t))}async _OnRequestPermission(e){const t=e.type;let s=!0;t===0?s=await this._RequestOrientationPermission():t===1&&(s=await this._RequestMotionPermission()),this.PostToRuntime("permission-result",{type:t,result:s})}async _RequestOrientationPermission(){if(!self.DeviceOrientationEvent||!self.DeviceOrientationEvent.requestPermission)return!0;try{return await self.DeviceOrientationEvent.requestPermission()==="granted"}catch(e){return console.warn("[Touch] Failed to request orientation permission: ",e),!1}}async _RequestMotionPermission(){if(!self.DeviceMotionEvent||!self.DeviceMotionEvent.requestPermission)return!0;try{return await self.DeviceMotionEvent.requestPermission()==="granted"}catch(e){return console.warn("[Touch] Failed to request motion permission: ",e),!1}}};self.RuntimeInterface.AddDOMHandlerClass(a)}{let d=function(t,s){if(t){if(s)return Array.from(document.querySelectorAll(t));{const o=document.querySelector(t);return o?[o]:[]}}else return[document.documentElement]},a=function(){};const i="browser",e=class extends self.DOMHandler{constructor(s){super(s,i),this._exportType="",this.AddRuntimeMessageHandlers([["get-initial-state",o=>this._OnGetInitialState(o)],["ready-for-sw-messages",()=>this._OnReadyForSWMessages()],["alert",o=>this._OnAlert(o)],["close",()=>this._OnClose()],["set-focus",o=>this._OnSetFocus(o)],["vibrate",o=>this._OnVibrate(o)],["lock-orientation",o=>this._OnLockOrientation(o)],["unlock-orientation",()=>this._OnUnlockOrientation()],["navigate",o=>this._OnNavigate(o)],["request-fullscreen",o=>this._OnRequestFullscreen(o)],["exit-fullscreen",()=>this._OnExitFullscreen()],["set-hash",o=>this._OnSetHash(o)],["set-document-css-style",o=>this._OnSetDocumentCSSStyle(o)],["get-document-css-style",o=>this._OnGetDocumentCSSStyle(o)]]),window.addEventListener("online",()=>this._OnOnlineStateChanged(!0)),window.addEventListener("offline",()=>this._OnOnlineStateChanged(!1)),window.addEventListener("hashchange",()=>this._OnHashChange()),document.addEventListener("backbutton",()=>this._OnCordovaBackButton())}_OnGetInitialState(s){return this._exportType=s.exportType,{location:location.toString(),isOnline:!!navigator.onLine,referrer:document.referrer,title:document.title,isCookieEnabled:!!navigator.cookieEnabled,screenWidth:screen.width,screenHeight:screen.height,windowOuterWidth:window.outerWidth,windowOuterHeight:window.outerHeight,isConstructArcade:typeof window.is_scirra_arcade<"u"}}_OnReadyForSWMessages(){!window.C3_RegisterSW||!window.OfflineClientInfo||window.OfflineClientInfo.SetMessageCallback(s=>this.PostToRuntime("sw-message",s.data))}_OnOnlineStateChanged(s){this.PostToRuntime("online-state",{isOnline:s})}_OnCordovaBackButton(){this.PostToRuntime("backbutton")}GetNWjsWindow(){return this._exportType==="nwjs"?nw.Window.get():null}_OnAlert(s){alert(s.message)}_OnClose(){navigator.app&&navigator.app.exitApp?navigator.app.exitApp():navigator.device&&navigator.device.exitApp?navigator.device.exitApp():window.close()}_OnSetFocus(s){const o=s.isFocus;if(this._exportType==="nwjs"){const u=this.GetNWjsWindow();o?u.focus():u.blur()}else o?window.focus():window.blur()}_OnVibrate(s){navigator.vibrate&&navigator.vibrate(s.pattern)}_OnLockOrientation(s){const o=s.orientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(o).catch(u=>console.warn("[Construct] Failed to lock orientation: ",u));else try{let u=!1;screen.lockOrientation?u=screen.lockOrientation(o):screen.webkitLockOrientation?u=screen.webkitLockOrientation(o):screen.mozLockOrientation?u=screen.mozLockOrientation(o):screen.msLockOrientation&&(u=screen.msLockOrientation(o)),u||console.warn("[Construct] Failed to lock orientation")}catch(u){console.warn("[Construct] Failed to lock orientation: ",u)}}_OnUnlockOrientation(){try{screen.orientation&&screen.orientation.unlock?screen.orientation.unlock():screen.unlockOrientation?screen.unlockOrientation():screen.webkitUnlockOrientation?screen.webkitUnlockOrientation():screen.mozUnlockOrientation?screen.mozUnlockOrientation():screen.msUnlockOrientation&&screen.msUnlockOrientation()}catch{}}_OnNavigate(s){const o=s.type;if(o==="back")navigator.app&&navigator.app.backHistory?navigator.app.backHistory():window.history.back();else if(o==="forward")window.history.forward();else if(o==="reload")location.reload();else if(o==="url"){const u=s.url,h=s.target,m=s.exportType;self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(u,"_system"):m==="preview"||this._iRuntime.IsWebView2Wrapper()?window.open(u,"_blank"):this._isConstructArcade||(h===2?window.top.location=u:h===1?window.parent.location=u:window.location=u)}else if(o==="new-window"){const u=s.url,h=s.tag;self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(u,"_system"):window.open(u,h)}}_OnRequestFullscreen(s){if(this._iRuntime.IsWebView2Wrapper()||this._exportType==="macos-wkwebview")self.RuntimeInterface._SetWrapperIsFullscreenFlag(!0),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!0});else{const o={navigationUI:"auto"},u=s.navUI;u===1?o.navigationUI="hide":u===2&&(o.navigationUI="show");const h=document.documentElement;let m;h.requestFullscreen?m=h.requestFullscreen(o):h.mozRequestFullScreen?m=h.mozRequestFullScreen(o):h.msRequestFullscreen?m=h.msRequestFullscreen(o):h.webkitRequestFullScreen&&(typeof Element.ALLOW_KEYBOARD_INPUT<"u"?m=h.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):m=h.webkitRequestFullScreen()),m instanceof Promise&&m.catch(a)}}_OnExitFullscreen(){if(this._iRuntime.IsWebView2Wrapper()||this._exportType==="macos-wkwebview")self.RuntimeInterface._SetWrapperIsFullscreenFlag(!1),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!1});else{let s;document.exitFullscreen?s=document.exitFullscreen():document.mozCancelFullScreen?s=document.mozCancelFullScreen():document.msExitFullscreen?s=document.msExitFullscreen():document.webkitCancelFullScreen&&(s=document.webkitCancelFullScreen()),s instanceof Promise&&s.catch(a)}}_OnSetHash(s){location.hash=s.hash}_OnHashChange(){this.PostToRuntime("hashchange",{location:location.toString()})}_OnSetDocumentCSSStyle(s){const o=s.prop,u=s.value,h=s.selector,m=s["is-all"];try{const v=d(h,m);for(const S of v)o.startsWith("--")?S.style.setProperty(o,u):S.style[o]=u}catch(v){console.warn("[Browser] Failed to set style: ",v)}}_OnGetDocumentCSSStyle(s){const o=s.prop,u=s.selector;try{const h=document.querySelector(u);return h?{isOk:!0,result:window.getComputedStyle(h).getPropertyValue(o)}:{isOk:!1}}catch(h){return console.warn("[Browser] Failed to get style: ",h),{isOk:!1}}}};self.RuntimeInterface.AddDOMHandlerClass(e),window.dispatchEvent(new CustomEvent("basket-ready"))}window.C3_RegisterSW=async function(){if(navigator.serviceWorker)try{const a=await navigator.serviceWorker.register("sw.js",{scope:"./"});console.info("Registered service worker on "+a.scope)}catch(a){console.warn("Failed to register service worker: ",a)}};
